services:
  # MySQL 服务
  mysql:
    image: mysql:8.0
    container_name: pandora-mysql
    restart: always
    ports:
      - "${MYSQL_HOST_PORT:-3307}:3306" # 宿主机:容器 (允许 Navicat 连接 localhost:3307)
    environment:
      - MYSQL_DATABASE=${MYSQL_DATABASE:-pandora_repo}
      - MYSQL_USER=${MYSQL_USER:-appuser}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:?MYSQL_PASSWORD is required}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD:?MYSQL_ROOT_PASSWORD is required}
      - TZ=${TZ:-UTC}
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "127.0.0.1", "-u", "${MYSQL_USER:-appuser}", "-p${MYSQL_PASSWORD:?MYSQL_PASSWORD is required}"]
      interval: 5s
      timeout: 3s
      retries: 30
    volumes:
      - mysql_data:/var/lib/mysql # 数据持久化
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci

  # Redis 服务
  redis:
    image: redis:alpine
    container_name: pandora-redis
    restart: always
    ports:
      - "${REDIS_HOST_PORT:-6380}:6379" # 宿主机:容器 (允许 RedisInsight 连接 localhost:6380)
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 30
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: pandora-backend
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/${MYSQL_DATABASE:-pandora_repo}?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=${MYSQL_USER:-appuser}
      - SPRING_DATASOURCE_PASSWORD=${MYSQL_PASSWORD:?MYSQL_PASSWORD is required}
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
      - SPRING_RABBITMQ_HOST=rabbitmq
      - SPRING_RABBITMQ_PORT=5672
      - SPRING_RABBITMQ_USERNAME=${RABBITMQ_DEFAULT_USER:-appuser}
      - SPRING_RABBITMQ_PASSWORD=${RABBITMQ_DEFAULT_PASS:?RABBITMQ_DEFAULT_PASS is required}
      - GLM_API_KEY=${GLM_API_KEY:?GLM_API_KEY is required}
      - GLM_API_URL=${GLM_API_URL:-https://open.bigmodel.cn/api/paas/v4}
      - GLM_MODEL=${GLM_MODEL:-glm-4}
      - PHONE_ENCRYPTION_KEY_BASE64=${PHONE_ENCRYPTION_KEY_BASE64:?PHONE_ENCRYPTION_KEY_BASE64 is required}
      - PHONE_HASH_PEPPER=${PHONE_HASH_PEPPER:?PHONE_HASH_PEPPER is required}
      - ALIYUN_OSS_ENDPOINT=${ALIYUN_OSS_ENDPOINT:?ALIYUN_OSS_ENDPOINT is required}
      - ALIYUN_OSS_ACCESS_KEY_ID=${ALIYUN_OSS_ACCESS_KEY_ID:?ALIYUN_OSS_ACCESS_KEY_ID is required}
      - ALIYUN_OSS_ACCESS_KEY_SECRET=${ALIYUN_OSS_ACCESS_KEY_SECRET:?ALIYUN_OSS_ACCESS_KEY_SECRET is required}
      - ALIYUN_OSS_BUCKET_NAME=${ALIYUN_OSS_BUCKET_NAME:?ALIYUN_OSS_BUCKET_NAME is required}
      - ALIYUN_OSS_DIR_PREFIX=${ALIYUN_OSS_DIR_PREFIX:-attachments/}

  nginx:
    image: nginx:1.27-alpine
    container_name: pandora-nginx
    restart: always
    depends_on:
      backend:
        condition: service_started
    ports:
      - "${NGINX_HOST_PORT:-80}:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: pandora-cloudflared
    restart: always
    depends_on:
      nginx:
        condition: service_started
    command: tunnel --no-autoupdate --protocol http2 --edge-ip-version 4 run --token ${CLOUDFLARED_TUNNEL_TOKEN:?CLOUDFLARED_TUNNEL_TOKEN is required}

  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: pandora-rabbitmq
    restart: always
    ports:
      - "${RABBITMQ_HOST_PORT:-5672}:5672"   # AMQP
      - "${RABBITMQ_MANAGEMENT_HOST_PORT:-15672}:15672" # Management UI
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER:-appuser}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS:?RABBITMQ_DEFAULT_PASS is required}
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 5s
      timeout: 5s
      retries: 30
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

volumes:
  mysql_data:
  redis_data:
  rabbitmq_data:
