# åç«¯ä»»åŠ¡é™„ä»¶åŠŸèƒ½è‡ªæŸ¥æ¸…å•

## ğŸ› é—®é¢˜æè¿°

**ç°è±¡ï¼š** å‰ç«¯åˆ›å»ºä»»åŠ¡æ—¶ä¸Šä¼ äº†é™„ä»¶ï¼Œä½†æŸ¥è¯¢ä»»åŠ¡è¯¦æƒ…æ—¶ `attachments` å­—æ®µæ€»æ˜¯ä¸ºç©ºã€‚

**å‰ç«¯çŠ¶æ€ï¼š** âœ… å·²ç¡®è®¤å‰ç«¯ä»£ç å®Œå…¨æ­£ç¡®ï¼Œé™„ä»¶ä¸Šä¼ æ–¹å¼ä¸æ—¥å¿—åŠŸèƒ½å®Œå…¨ä¸€è‡´ï¼ˆæ—¥å¿—é™„ä»¶åŠŸèƒ½æ­£å¸¸ï¼‰ã€‚

**ç»“è®ºï¼š** é—®é¢˜å‡ºåœ¨åç«¯ä»£ç ã€‚

---

## ğŸ“‹ è‡ªæŸ¥æ¸…å•

### âœ… ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ä»»åŠ¡åˆ›å»ºæ¥å£æ˜¯å¦æ¥æ”¶å¹¶ä¿å­˜é™„ä»¶

#### 1.1 æ£€æŸ¥ Controller å±‚

**æ–‡ä»¶ï¼š** `TaskController.java`ï¼ˆæˆ–ç±»ä¼¼æ–‡ä»¶ï¼‰

**æ£€æŸ¥ç‚¹ï¼š**

```java
@PostMapping("/tasks")
public ResponseEntity<?> createTask(
    HttpServletRequest request,
    @RequestParam("title") String title,
    @RequestParam("content") String content,
    @RequestParam("startTime") String startTime,
    @RequestParam("endTime") String endTime,
    @RequestParam("taskPriority") String taskPriority,
    @RequestParam(value = "taskType", required = false) String taskType,
    @RequestParam(value = "milestoneId", required = false) Integer milestoneId,
    @RequestParam(value = "assigneeId", required = false) Integer assigneeId,
    @RequestParam(value = "senderId", required = false) Integer senderId,
    
    // â“ æ£€æŸ¥ç‚¹1ï¼šæ˜¯å¦æœ‰è¿™ä¸ªå‚æ•°ï¼Ÿ
    @RequestParam(value = "files", required = false) MultipartFile[] files
) {
    // ... åˆ›å»ºä»»åŠ¡é€»è¾‘
    
    // â“ æ£€æŸ¥ç‚¹2ï¼šæ˜¯å¦æœ‰ä¿å­˜é™„ä»¶çš„ä»£ç ï¼Ÿ
    if (files != null && files.length > 0) {
        // ä¿å­˜é™„ä»¶é€»è¾‘
    }
}
```

**è‡ªæŸ¥é—®é¢˜ï¼š**

- [ ] **é—®é¢˜1ï¼š** æ–¹æ³•å‚æ•°ä¸­æ˜¯å¦æœ‰ `MultipartFile[] files` å‚æ•°ï¼Ÿ
- [ ] **é—®é¢˜2ï¼š** å‚æ•°åæ˜¯å¦ä¸º `"files"`ï¼ˆå¤æ•°å½¢å¼ï¼‰ï¼Ÿ
- [ ] **é—®é¢˜3ï¼š** æ˜¯å¦æœ‰å¤„ç† `files` å‚æ•°çš„ä»£ç ï¼Ÿ

---

#### 1.2 æ£€æŸ¥ Service å±‚ - é™„ä»¶ä¿å­˜é€»è¾‘

**æ–‡ä»¶ï¼š** `TaskService.java` æˆ– `TaskServiceImpl.java`

**æœŸæœ›çš„ä»£ç ï¼š**

```java
public Task createTask(TaskDTO taskDTO, MultipartFile[] files) {
    // 1. ä¿å­˜ä»»åŠ¡åŸºæœ¬ä¿¡æ¯
    Task task = new Task();
    task.setTitle(taskDTO.getTitle());
    task.setContent(taskDTO.getContent());
    // ... è®¾ç½®å…¶ä»–å­—æ®µ
    task = taskRepository.save(task);
    
    // 2. â“ æ£€æŸ¥ç‚¹ï¼šæ˜¯å¦æœ‰ä¿å­˜é™„ä»¶çš„é€»è¾‘ï¼Ÿ
    if (files != null && files.length > 0) {
        for (MultipartFile file : files) {
            try {
                // ä¿å­˜æ–‡ä»¶åˆ°ç£ç›˜
                String storedFilename = fileStorageService.storeFile(file);
                
                // ä¿å­˜é™„ä»¶ä¿¡æ¯åˆ°æ•°æ®åº“
                TaskAttachment attachment = new TaskAttachment();
                attachment.setTask(task);  // æˆ– attachment.setTaskId(task.getTaskId());
                attachment.setOriginalFilename(file.getOriginalFilename());
                attachment.setStoredFilename(storedFilename);
                attachment.setFileType(file.getContentType());
                attachment.setFileSize(file.getSize());
                attachment.setUploadTime(LocalDateTime.now());
                
                taskAttachmentRepository.save(attachment);
                
                System.out.println("âœ… ä¿å­˜é™„ä»¶: " + file.getOriginalFilename());
            } catch (Exception e) {
                System.err.println("âŒ ä¿å­˜é™„ä»¶å¤±è´¥: " + e.getMessage());
                e.printStackTrace();
            }
        }
    } else {
        System.out.println("âš ï¸ æ²¡æœ‰æ”¶åˆ°é™„ä»¶æ–‡ä»¶");
    }
    
    return task;
}
```

**è‡ªæŸ¥é—®é¢˜ï¼š**

- [ ] **é—®é¢˜4ï¼š** Service æ–¹æ³•æ˜¯å¦æ¥æ”¶ `MultipartFile[] files` å‚æ•°ï¼Ÿ
- [ ] **é—®é¢˜5ï¼š** æ˜¯å¦æœ‰å¾ªç¯å¤„ç†æ¯ä¸ªæ–‡ä»¶çš„ä»£ç ï¼Ÿ
- [ ] **é—®é¢˜6ï¼š** æ˜¯å¦è°ƒç”¨äº† `fileStorageService.storeFile()` ä¿å­˜æ–‡ä»¶åˆ°ç£ç›˜ï¼Ÿ
- [ ] **é—®é¢˜7ï¼š** æ˜¯å¦åˆ›å»ºäº† `TaskAttachment` å¯¹è±¡å¹¶ä¿å­˜åˆ°æ•°æ®åº“ï¼Ÿ
- [ ] **é—®é¢˜8ï¼š** æ˜¯å¦æ­£ç¡®å…³è”äº†ä»»åŠ¡IDï¼ˆ`attachment.setTask(task)` æˆ– `attachment.setTaskId(taskId)`ï¼‰ï¼Ÿ

---

#### 1.3 æ£€æŸ¥æ•°æ®åº“è¡¨æ˜¯å¦å­˜åœ¨

**æ‰§è¡Œ SQLï¼š**

```sql
-- æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
SHOW TABLES LIKE 'task_attachment';

-- æŸ¥çœ‹è¡¨ç»“æ„
DESC task_attachment;

-- æŸ¥çœ‹æ˜¯å¦æœ‰æ•°æ®
SELECT * FROM task_attachment;
```

**æœŸæœ›çš„è¡¨ç»“æ„ï¼š**

```sql
CREATE TABLE task_attachment (
    attachment_id INT AUTO_INCREMENT PRIMARY KEY,
    task_id INT NOT NULL,
    original_filename VARCHAR(255) NOT NULL,
    stored_filename VARCHAR(255) NOT NULL,
    file_type VARCHAR(100),
    file_size BIGINT,
    upload_time DATETIME,
    FOREIGN KEY (task_id) REFERENCES task(task_id) ON DELETE CASCADE
);
```

**è‡ªæŸ¥é—®é¢˜ï¼š**

- [ ] **é—®é¢˜9ï¼š** `task_attachment` è¡¨æ˜¯å¦å­˜åœ¨ï¼Ÿ
- [ ] **é—®é¢˜10ï¼š** è¡¨ç»“æ„æ˜¯å¦æ­£ç¡®ï¼Ÿ
- [ ] **é—®é¢˜11ï¼š** æ˜¯å¦æœ‰å¤–é”®å…³è”åˆ° `task` è¡¨ï¼Ÿ

---

### âœ… ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ä»»åŠ¡è¯¦æƒ…æŸ¥è¯¢æ¥å£æ˜¯å¦è¿”å›é™„ä»¶

#### 2.1 æ£€æŸ¥ Controller å±‚

**æ–‡ä»¶ï¼š** `TaskController.java`

**æ£€æŸ¥ç‚¹ï¼š**

```java
@GetMapping("/tasks/{id}")
public ResponseEntity<?> getTaskById(@PathVariable("id") Integer taskId) {
    // â“ æ£€æŸ¥ç‚¹ï¼šæ˜¯å¦æŸ¥è¯¢å¹¶è¿”å›äº†é™„ä»¶ï¼Ÿ
    Task task = taskService.getTaskById(taskId);
    
    // æ„å»ºå“åº”
    Map<String, Object> response = new HashMap<>();
    response.put("taskId", task.getTaskId());
    response.put("title", task.getTitle());
    // ... å…¶ä»–å­—æ®µ
    
    // â“ æ£€æŸ¥ç‚¹ï¼šæ˜¯å¦æœ‰è¿™è¡Œä»£ç ï¼Ÿ
    List<TaskAttachment> attachments = taskAttachmentRepository.findByTaskId(taskId);
    response.put("attachments", attachments);  // â† å…³é”®ï¼
    
    return ResponseEntity.ok(response);
}
```

**è‡ªæŸ¥é—®é¢˜ï¼š**

- [ ] **é—®é¢˜12ï¼š** æ˜¯å¦æŸ¥è¯¢äº† `task_attachment` è¡¨ï¼Ÿ
- [ ] **é—®é¢˜13ï¼š** æ˜¯å¦å°†é™„ä»¶æ•°æ®æ”¾å…¥å“åº”ä¸­ï¼ˆ`response.put("attachments", ...)`ï¼‰ï¼Ÿ
- [ ] **é—®é¢˜14ï¼š** å­—æ®µåæ˜¯å¦ä¸º `"attachments"`ï¼ˆå¤æ•°å½¢å¼ï¼‰ï¼Ÿ

---

#### 2.2 æ£€æŸ¥ Repository å±‚

**æ–‡ä»¶ï¼š** `TaskAttachmentRepository.java`

**æœŸæœ›çš„ä»£ç ï¼š**

```java
public interface TaskAttachmentRepository extends JpaRepository<TaskAttachment, Integer> {
    
    // â“ æ£€æŸ¥ç‚¹ï¼šæ˜¯å¦æœ‰è¿™ä¸ªæ–¹æ³•ï¼Ÿ
    List<TaskAttachment> findByTaskId(Integer taskId);
    
    // æˆ–è€…ä½¿ç”¨è‡ªå®šä¹‰æŸ¥è¯¢
    @Query("SELECT a FROM TaskAttachment a WHERE a.task.taskId = :taskId")
    List<TaskAttachment> findByTaskId(@Param("taskId") Integer taskId);
}
```

**è‡ªæŸ¥é—®é¢˜ï¼š**

- [ ] **é—®é¢˜15ï¼š** `TaskAttachmentRepository` æ˜¯å¦å­˜åœ¨ï¼Ÿ
- [ ] **é—®é¢˜16ï¼š** æ˜¯å¦æœ‰ `findByTaskId()` æ–¹æ³•ï¼Ÿ

---

#### 2.3 æ£€æŸ¥è¿”å›çš„ JSON æ ¼å¼

**æœŸæœ›çš„å“åº”æ ¼å¼ï¼š**

```json
{
  "taskId": 123,
  "title": "æµ‹è¯•ä»»åŠ¡",
  "content": "ä»»åŠ¡æè¿°",
  "attachments": [
    {
      "attachmentId": 456,
      "originalFilename": "test.pdf",
      "fileType": "application/pdf",
      "fileSize": 1024000
    }
  ]
}
```

**è‡ªæŸ¥é—®é¢˜ï¼š**

- [ ] **é—®é¢˜17ï¼š** å“åº”ä¸­æ˜¯å¦åŒ…å« `attachments` å­—æ®µï¼Ÿ
- [ ] **é—®é¢˜18ï¼š** `attachments` æ˜¯å¦ä¸ºæ•°ç»„ç±»å‹ï¼Ÿ
- [ ] **é—®é¢˜19ï¼š** æ•°ç»„ä¸­çš„å¯¹è±¡æ˜¯å¦åŒ…å« `attachmentId`ã€`originalFilename`ã€`fileType`ã€`fileSize` å­—æ®µï¼Ÿ

---

### âœ… ç¬¬ä¸‰æ­¥ï¼šå¯¹æ¯”æ—¥å¿—é™„ä»¶åŠŸèƒ½ï¼ˆå·²æ­£å¸¸å·¥ä½œï¼‰

**æ—¥å¿—é™„ä»¶åŠŸèƒ½æ­£å¸¸ï¼Œè¯´æ˜ä»¥ä¸‹ä»£ç æ˜¯æ­£ç¡®çš„ï¼š**

1. âœ… `FileStorageService` - æ–‡ä»¶å­˜å‚¨æœåŠ¡æ­£å¸¸
2. âœ… `LogAttachmentRepository` - é™„ä»¶æ•°æ®åº“æ“ä½œæ­£å¸¸
3. âœ… `LogController` æ¥æ”¶ `MultipartFile[]` å‚æ•°æ­£å¸¸

**è¯·å¯¹æ¯”æ—¥å¿—å’Œä»»åŠ¡çš„ä»£ç å·®å¼‚ï¼š**

#### 3.1 å¯¹æ¯” Controller å±‚

```java
// æ—¥å¿—åˆ›å»ºæ¥å£ï¼ˆæ­£å¸¸ï¼‰
@PostMapping("/logs")
public ResponseEntity<?> createLog(
    @RequestParam("content") String content,
    @RequestParam(value = "files", required = false) MultipartFile[] files  // âœ… æœ‰è¿™ä¸ªå‚æ•°
) {
    // ... ä¿å­˜é™„ä»¶é€»è¾‘
}

// ä»»åŠ¡åˆ›å»ºæ¥å£ï¼ˆæœ‰é—®é¢˜ï¼‰
@PostMapping("/tasks")
public ResponseEntity<?> createTask(
    @RequestParam("title") String title,
    @RequestParam(value = "files", required = false) MultipartFile[] files  // â“ æœ‰è¿™ä¸ªå‚æ•°å—ï¼Ÿ
) {
    // ... ä¿å­˜é™„ä»¶é€»è¾‘
}
```

**è‡ªæŸ¥é—®é¢˜ï¼š**

- [ ] **é—®é¢˜20ï¼š** ä»»åŠ¡åˆ›å»ºæ¥å£æ˜¯å¦åƒæ—¥å¿—æ¥å£ä¸€æ ·æ¥æ”¶ `files` å‚æ•°ï¼Ÿ
- [ ] **é—®é¢˜21ï¼š** ä»»åŠ¡åˆ›å»ºæ¥å£æ˜¯å¦åƒæ—¥å¿—æ¥å£ä¸€æ ·ä¿å­˜é™„ä»¶ï¼Ÿ

---

#### 3.2 å¯¹æ¯” Service å±‚

```java
// æ—¥å¿— Serviceï¼ˆæ­£å¸¸ï¼‰
public Log createLog(LogDTO logDTO, MultipartFile[] files) {
    Log log = logRepository.save(log);
    
    // âœ… ä¿å­˜é™„ä»¶
    if (files != null && files.length > 0) {
        for (MultipartFile file : files) {
            LogAttachment attachment = new LogAttachment();
            attachment.setLog(log);
            // ... ä¿å­˜é™„ä»¶
            logAttachmentRepository.save(attachment);
        }
    }
    
    return log;
}

// ä»»åŠ¡ Serviceï¼ˆæœ‰é—®é¢˜ï¼‰
public Task createTask(TaskDTO taskDTO, MultipartFile[] files) {
    Task task = taskRepository.save(task);
    
    // â“ æœ‰ä¿å­˜é™„ä»¶çš„ä»£ç å—ï¼Ÿ
    if (files != null && files.length > 0) {
        for (MultipartFile file : files) {
            TaskAttachment attachment = new TaskAttachment();
            attachment.setTask(task);
            // ... ä¿å­˜é™„ä»¶
            taskAttachmentRepository.save(attachment);
        }
    }
    
    return task;
}
```

**è‡ªæŸ¥é—®é¢˜ï¼š**

- [ ] **é—®é¢˜22ï¼š** ä»»åŠ¡ Service æ˜¯å¦åƒæ—¥å¿— Service ä¸€æ ·ä¿å­˜é™„ä»¶ï¼Ÿ

---

#### 3.3 å¯¹æ¯”æŸ¥è¯¢æ¥å£

```java
// æ—¥å¿—è¯¦æƒ…æŸ¥è¯¢ï¼ˆæ­£å¸¸ï¼‰
@GetMapping("/logs/{id}")
public ResponseEntity<?> getLogById(@PathVariable Integer id) {
    Log log = logRepository.findById(id).orElseThrow(...);
    
    // âœ… æŸ¥è¯¢é™„ä»¶
    List<LogAttachment> attachments = logAttachmentRepository.findByLogId(id);
    
    // âœ… è¿”å›é™„ä»¶
    response.put("attachments", attachments);
    
    return ResponseEntity.ok(response);
}

// ä»»åŠ¡è¯¦æƒ…æŸ¥è¯¢ï¼ˆæœ‰é—®é¢˜ï¼‰
@GetMapping("/tasks/{id}")
public ResponseEntity<?> getTaskById(@PathVariable Integer id) {
    Task task = taskRepository.findById(id).orElseThrow(...);
    
    // â“ æŸ¥è¯¢é™„ä»¶äº†å—ï¼Ÿ
    List<TaskAttachment> attachments = taskAttachmentRepository.findByTaskId(id);
    
    // â“ è¿”å›é™„ä»¶äº†å—ï¼Ÿ
    response.put("attachments", attachments);
    
    return ResponseEntity.ok(response);
}
```

**è‡ªæŸ¥é—®é¢˜ï¼š**

- [ ] **é—®é¢˜23ï¼š** ä»»åŠ¡æŸ¥è¯¢æ¥å£æ˜¯å¦åƒæ—¥å¿—æŸ¥è¯¢æ¥å£ä¸€æ ·è¿”å›é™„ä»¶ï¼Ÿ

---

## ğŸ” è°ƒè¯•æ­¥éª¤

### æ­¥éª¤1ï¼šæ·»åŠ æ—¥å¿—è¾“å‡º

åœ¨ `TaskController.createTask()` æ–¹æ³•ä¸­æ·»åŠ ï¼š

```java
@PostMapping("/tasks")
public ResponseEntity<?> createTask(
    @RequestParam("title") String title,
    @RequestParam(value = "files", required = false) MultipartFile[] files
) {
    // ğŸ” è°ƒè¯•æ—¥å¿—
    System.out.println("========== åˆ›å»ºä»»åŠ¡è°ƒè¯•ä¿¡æ¯ ==========");
    System.out.println("æ ‡é¢˜: " + title);
    System.out.println("æ”¶åˆ°çš„æ–‡ä»¶æ•°é‡: " + (files != null ? files.length : 0));
    
    if (files != null && files.length > 0) {
        for (int i = 0; i < files.length; i++) {
            System.out.println("æ–‡ä»¶[" + i + "]: " + files[i].getOriginalFilename());
            System.out.println("  - å¤§å°: " + files[i].getSize() + " bytes");
            System.out.println("  - ç±»å‹: " + files[i].getContentType());
        }
    } else {
        System.out.println("âš ï¸ æ²¡æœ‰æ”¶åˆ°æ–‡ä»¶ï¼");
    }
    System.out.println("=====================================");
    
    // ... åŸæœ‰é€»è¾‘
}
```

---

### æ­¥éª¤2ï¼šæ£€æŸ¥æ•°æ®åº“

åˆ›å»ºä»»åŠ¡åï¼Œç«‹å³æŸ¥è¯¢æ•°æ®åº“ï¼š

```sql
-- æŸ¥çœ‹æœ€æ–°åˆ›å»ºçš„ä»»åŠ¡
SELECT * FROM task ORDER BY task_id DESC LIMIT 1;

-- æŸ¥çœ‹è¯¥ä»»åŠ¡çš„é™„ä»¶ï¼ˆå‡è®¾ä»»åŠ¡IDæ˜¯123ï¼‰
SELECT * FROM task_attachment WHERE task_id = 123;
```

**é¢„æœŸç»“æœï¼š**

- å¦‚æœ `task_attachment` è¡¨**æœ‰æ•°æ®** â†’ è¯´æ˜é™„ä»¶ä¿å­˜æˆåŠŸï¼Œé—®é¢˜åœ¨æŸ¥è¯¢æ¥å£
- å¦‚æœ `task_attachment` è¡¨**æ²¡æœ‰æ•°æ®** â†’ è¯´æ˜é™„ä»¶æ²¡æœ‰ä¿å­˜ï¼Œé—®é¢˜åœ¨åˆ›å»ºæ¥å£

---

### æ­¥éª¤3ï¼šæ£€æŸ¥æŸ¥è¯¢æ¥å£çš„å“åº”

åœ¨ `TaskController.getTaskById()` æ–¹æ³•ä¸­æ·»åŠ ï¼š

```java
@GetMapping("/tasks/{id}")
public ResponseEntity<?> getTaskById(@PathVariable Integer id) {
    Task task = taskRepository.findById(id).orElseThrow(...);
    
    // ğŸ” è°ƒè¯•æ—¥å¿—
    System.out.println("========== æŸ¥è¯¢ä»»åŠ¡è°ƒè¯•ä¿¡æ¯ ==========");
    System.out.println("ä»»åŠ¡ID: " + id);
    
    List<TaskAttachment> attachments = taskAttachmentRepository.findByTaskId(id);
    System.out.println("æŸ¥è¯¢åˆ°çš„é™„ä»¶æ•°é‡: " + attachments.size());
    
    if (!attachments.isEmpty()) {
        for (TaskAttachment att : attachments) {
            System.out.println("é™„ä»¶: " + att.getOriginalFilename());
        }
    } else {
        System.out.println("âš ï¸ æ²¡æœ‰æŸ¥è¯¢åˆ°é™„ä»¶ï¼");
    }
    System.out.println("=====================================");
    
    // æ„å»ºå“åº”
    Map<String, Object> response = new HashMap<>();
    // ... å…¶ä»–å­—æ®µ
    response.put("attachments", attachments);  // â† ç¡®ä¿æœ‰è¿™è¡Œ
    
    System.out.println("å“åº”ä¸­çš„attachmentså­—æ®µ: " + response.get("attachments"));
    
    return ResponseEntity.ok(response);
}
```

---

## ğŸ¯ æœ€å¯èƒ½çš„é—®é¢˜

æ ¹æ®ç»éªŒï¼Œ**æœ€å¯èƒ½çš„é—®é¢˜æ˜¯ä»¥ä¸‹å‡ ç§ï¼š**

### âŒ é—®é¢˜1ï¼šåˆ›å»ºä»»åŠ¡æ—¶æ²¡æœ‰æ¥æ”¶ `files` å‚æ•°

**ç—‡çŠ¶ï¼š** åç«¯æ—¥å¿—æ˜¾ç¤º `æ”¶åˆ°çš„æ–‡ä»¶æ•°é‡: 0`

**ä¿®å¤ï¼š** åœ¨ `@PostMapping("/tasks")` æ–¹æ³•ä¸­æ·»åŠ  `MultipartFile[] files` å‚æ•°

---

### âŒ é—®é¢˜2ï¼šåˆ›å»ºä»»åŠ¡æ—¶æ²¡æœ‰ä¿å­˜é™„ä»¶åˆ°æ•°æ®åº“

**ç—‡çŠ¶ï¼š** åç«¯æ—¥å¿—æ˜¾ç¤ºæ”¶åˆ°äº†æ–‡ä»¶ï¼Œä½†æ•°æ®åº“ä¸­æ²¡æœ‰è®°å½•

**ä¿®å¤ï¼š** åœ¨ Service å±‚æ·»åŠ ä¿å­˜é™„ä»¶çš„ä»£ç ï¼ˆå‚è€ƒæ—¥å¿—åŠŸèƒ½ï¼‰

---

### âŒ é—®é¢˜3ï¼šæŸ¥è¯¢ä»»åŠ¡æ—¶æ²¡æœ‰è¿”å›é™„ä»¶

**ç—‡çŠ¶ï¼š** æ•°æ®åº“ä¸­æœ‰é™„ä»¶è®°å½•ï¼Œä½†å‰ç«¯æ”¶åˆ°çš„ `attachments` ä¸ºç©º

**ä¿®å¤ï¼š** åœ¨æŸ¥è¯¢æ¥å£ä¸­æ·»åŠ ï¼š
```java
List<TaskAttachment> attachments = taskAttachmentRepository.findByTaskId(id);
response.put("attachments", attachments);
```

---

## âœ… ä¿®å¤åçš„å®Œæ•´ä»£ç ç¤ºä¾‹

### TaskController.java

```java
@RestController
@RequestMapping("/tasks")
public class TaskController {
    
    @Autowired
    private TaskService taskService;
    
    @Autowired
    private TaskAttachmentRepository taskAttachmentRepository;
    
    // åˆ›å»ºä»»åŠ¡
    @PostMapping
    public ResponseEntity<?> createTask(
        HttpServletRequest request,
        @RequestParam("title") String title,
        @RequestParam("content") String content,
        @RequestParam("startTime") String startTime,
        @RequestParam("endTime") String endTime,
        @RequestParam("taskPriority") String taskPriority,
        @RequestParam(value = "taskType", required = false) String taskType,
        @RequestParam(value = "milestoneId", required = false) Integer milestoneId,
        @RequestParam(value = "assigneeId", required = false) Integer assigneeId,
        @RequestParam(value = "files", required = false) MultipartFile[] files  // âœ… æ·»åŠ è¿™ä¸ªå‚æ•°
    ) {
        try {
            // åˆ›å»ºä»»åŠ¡å¹¶ä¿å­˜é™„ä»¶
            Task task = taskService.createTask(
                title, content, startTime, endTime, 
                taskPriority, taskType, milestoneId, assigneeId,
                files  // âœ… ä¼ é€’æ–‡ä»¶å‚æ•°
            );
            
            // æŸ¥è¯¢é™„ä»¶ï¼ˆç”¨äºè¿”å›ï¼‰
            List<TaskAttachment> attachments = taskAttachmentRepository.findByTaskId(task.getTaskId());
            
            // æ„å»ºå“åº”
            Map<String, Object> response = buildTaskResponse(task);
            response.put("attachments", attachments);  // âœ… è¿”å›é™„ä»¶
            
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            return ResponseEntity.badRequest().body("åˆ›å»ºä»»åŠ¡å¤±è´¥: " + e.getMessage());
        }
    }
    
    // æŸ¥è¯¢ä»»åŠ¡è¯¦æƒ…
    @GetMapping("/{id}")
    public ResponseEntity<?> getTaskById(@PathVariable Integer id) {
        try {
            Task task = taskService.getTaskById(id);
            
            // âœ… æŸ¥è¯¢é™„ä»¶
            List<TaskAttachment> attachments = taskAttachmentRepository.findByTaskId(id);
            
            // æ„å»ºå“åº”
            Map<String, Object> response = buildTaskResponse(task);
            response.put("attachments", attachments);  // âœ… è¿”å›é™„ä»¶
            
            return ResponseEntity.ok(response);
        } catch (Exception e) {
            return ResponseEntity.badRequest().body("æŸ¥è¯¢ä»»åŠ¡å¤±è´¥: " + e.getMessage());
        }
    }
    
    private Map<String, Object> buildTaskResponse(Task task) {
        Map<String, Object> response = new HashMap<>();
        response.put("taskId", task.getTaskId());
        response.put("title", task.getTitle());
        response.put("content", task.getContent());
        // ... å…¶ä»–å­—æ®µ
        return response;
    }
}
```

### TaskService.java

```java
@Service
public class TaskService {
    
    @Autowired
    private TaskRepository taskRepository;
    
    @Autowired
    private TaskAttachmentRepository taskAttachmentRepository;
    
    @Autowired
    private FileStorageService fileStorageService;
    
    public Task createTask(
        String title, String content, String startTime, String endTime,
        String taskPriority, String taskType, Integer milestoneId, Integer assigneeId,
        MultipartFile[] files  // âœ… æ·»åŠ è¿™ä¸ªå‚æ•°
    ) {
        // 1. ä¿å­˜ä»»åŠ¡åŸºæœ¬ä¿¡æ¯
        Task task = new Task();
        task.setTitle(title);
        task.setContent(content);
        // ... è®¾ç½®å…¶ä»–å­—æ®µ
        task = taskRepository.save(task);
        
        // 2. âœ… ä¿å­˜é™„ä»¶
        if (files != null && files.length > 0) {
            for (MultipartFile file : files) {
                try {
                    // ä¿å­˜æ–‡ä»¶åˆ°ç£ç›˜
                    String storedFilename = fileStorageService.storeFile(file);
                    
                    // ä¿å­˜é™„ä»¶ä¿¡æ¯åˆ°æ•°æ®åº“
                    TaskAttachment attachment = new TaskAttachment();
                    attachment.setTask(task);
                    attachment.setOriginalFilename(file.getOriginalFilename());
                    attachment.setStoredFilename(storedFilename);
                    attachment.setFileType(file.getContentType());
                    attachment.setFileSize(file.getSize());
                    attachment.setUploadTime(LocalDateTime.now());
                    
                    taskAttachmentRepository.save(attachment);
                    
                    System.out.println("âœ… ä¿å­˜é™„ä»¶æˆåŠŸ: " + file.getOriginalFilename());
                } catch (Exception e) {
                    System.err.println("âŒ ä¿å­˜é™„ä»¶å¤±è´¥: " + e.getMessage());
                    e.printStackTrace();
                }
            }
        }
        
        return task;
    }
}
```

---

## ğŸ“ æ€»ç»“

### å‰ç«¯çŠ¶æ€ï¼šâœ… å®Œå…¨æ­£ç¡®

- âœ… ä½¿ç”¨ `FormData` ä¸Šä¼ 
- âœ… å­—æ®µåä¸º `'files'`
- âœ… ä½¿ç”¨ `MultipartFile.fromFile()`
- âœ… ä¸æ—¥å¿—åŠŸèƒ½å®Œå…¨ä¸€è‡´

### åç«¯éœ€è¦æ£€æŸ¥çš„3ä¸ªå…³é”®ç‚¹ï¼š

1. **åˆ›å»ºä»»åŠ¡æ¥å£** - æ˜¯å¦æ¥æ”¶å¹¶ä¿å­˜äº† `files` å‚æ•°ï¼Ÿ
2. **æ•°æ®åº“** - `task_attachment` è¡¨ä¸­æ˜¯å¦æœ‰æ•°æ®ï¼Ÿ
3. **æŸ¥è¯¢ä»»åŠ¡æ¥å£** - æ˜¯å¦è¿”å›äº† `attachments` å­—æ®µï¼Ÿ

### å»ºè®®çš„è°ƒè¯•é¡ºåºï¼š

1. æ·»åŠ æ—¥å¿—è¾“å‡ºï¼ŒæŸ¥çœ‹æ˜¯å¦æ”¶åˆ°æ–‡ä»¶
2. æ£€æŸ¥æ•°æ®åº“ï¼ŒæŸ¥çœ‹æ˜¯å¦ä¿å­˜äº†é™„ä»¶
3. å¯¹æ¯”æ—¥å¿—åŠŸèƒ½çš„ä»£ç ï¼Œæ‰¾å‡ºå·®å¼‚
4. å‚è€ƒä¸Šé¢çš„å®Œæ•´ä»£ç ç¤ºä¾‹è¿›è¡Œä¿®å¤

---

**åˆ›å»ºæ—¶é—´ï¼š** 2025-11-20  
**ä¼˜å…ˆçº§ï¼š** ğŸ”´ é«˜  
**é¢„è®¡ä¿®å¤æ—¶é—´ï¼š** 30åˆ†é’Ÿ
