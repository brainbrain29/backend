# ç”¨æˆ·ç™»å½•æµç¨‹å’Œæ¥å£è°ƒç”¨æŒ‡å—

> **æ›´æ–°æ—¶é—´**: 2025-11-18  
> **é€‚ç”¨å‰ç«¯**: Web / Flutter / ç§»åŠ¨ç«¯  
> **é‡è¦**: è¯·ä¸¥æ ¼æŒ‰ç…§æœ¬æ–‡æ¡£çš„é¡ºåºè°ƒç”¨æ¥å£

---

## ğŸ“‹ ç›®å½•

1. [ç™»å½•æµç¨‹æ¦‚è§ˆ](#ç™»å½•æµç¨‹æ¦‚è§ˆ)
2. [æ¥å£1: ç”¨æˆ·ç™»å½•](#æ¥å£1-ç”¨æˆ·ç™»å½•)
3. [æ¥å£2: å»ºç«‹ SSE è¿æ¥](#æ¥å£2-å»ºç«‹-sse-è¿æ¥)
4. [æ¥å£3: åˆ·æ–° Token](#æ¥å£3-åˆ·æ–°-token)
5. [å®Œæ•´å‰ç«¯å®ç°ç¤ºä¾‹](#å®Œæ•´å‰ç«¯å®ç°ç¤ºä¾‹)
6. [é”™è¯¯å¤„ç†å’Œé‡è¿æœºåˆ¶](#é”™è¯¯å¤„ç†å’Œé‡è¿æœºåˆ¶)
7. [å¸¸è§é—®é¢˜ FAQ](#å¸¸è§é—®é¢˜-faq)

---

## ç™»å½•æµç¨‹æ¦‚è§ˆ

### **æ ‡å‡†ç™»å½•æµç¨‹ï¼ˆå¿…é¡»æŒ‰æ­¤é¡ºåºï¼‰**

```
æ­¥éª¤1: ç”¨æˆ·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç 
    â†“
æ­¥éª¤2: è°ƒç”¨ POST /auth/login
    â†“
æ­¥éª¤3: ä¿å­˜è¿”å›çš„ accessToken å’Œ refreshToken
    â†“
æ­¥éª¤4: å»ºç«‹ SSE è¿æ¥ GET /notifications/stream
    â†“
æ­¥éª¤5: ç›‘å¬é€šçŸ¥äº‹ä»¶
    â†“
æ­¥éª¤6: Token è¿‡æœŸå‰åˆ·æ–° POST /auth/refresh
```

### **æ—¶åºå›¾**

```
å‰ç«¯                          åç«¯
 |                             |
 |  1. POST /auth/login        |
 |--------------------------->  |
 |                             | éªŒè¯ç”¨æˆ·åå¯†ç 
 |  { accessToken, ... }       |
 |<--------------------------- |
 |                             |
 | ä¿å­˜ Token åˆ°æœ¬åœ°å­˜å‚¨         |
 |                             |
 |  2. GET /notifications/stream|
 |    (å¸¦ Token)               |
 |--------------------------->  |
 |                             | å»ºç«‹ SSE è¿æ¥
 |  SSE è¿æ¥å»ºç«‹æˆåŠŸ            |
 |<--------------------------- |
 |                             |
 | ç›‘å¬é€šçŸ¥äº‹ä»¶                 |
 |<---------------------------  | æ¨é€é€šçŸ¥
 |                             |
 | 3. å®šæ—¶åˆ·æ–° Token (50åˆ†é’Ÿå)  |
 |  POST /auth/refresh         |
 |--------------------------->  |
 |  { accessToken, ... }       |
 |<--------------------------- |
```

---

## æ¥å£1: ç”¨æˆ·ç™»å½•

### **æ¥å£ä¿¡æ¯**

- **URL**: `POST /auth/login`
- **è®¤è¯**: æ— éœ€è®¤è¯ï¼ˆå…¬å¼€æ¥å£ï¼‰
- **Content-Type**: `application/json`

### **è°ƒç”¨æ—¶æœº**

- âœ… ç”¨æˆ·åœ¨ç™»å½•é¡µé¢ç‚¹å‡»"ç™»å½•"æŒ‰é’®
- âœ… åº”ç”¨å¯åŠ¨æ—¶æ£€æµ‹åˆ°æ²¡æœ‰æœ‰æ•ˆçš„ Token

### **è¯·æ±‚å‚æ•°**

```json
{
  "phone": "13800138000",
  "password": "123456"
}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `phone` | `String` | æ˜¯ | ç”¨æˆ·æ‰‹æœºå· |
| `password` | `String` | æ˜¯ | ç”¨æˆ·å¯†ç  |

### **è¿”å›æ•°æ®**

**æˆåŠŸå“åº”** (200):
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "userId": 123,
  "position": 1,
  "employeeName": "å¼ ä¸‰"
}
```

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `accessToken` | `String` | è®¿é—®ä»¤ç‰Œï¼Œæœ‰æ•ˆæœŸ **1 å°æ—¶** |
| `refreshToken` | `String` | åˆ·æ–°ä»¤ç‰Œï¼Œæœ‰æ•ˆæœŸ **7 å¤©** |
| `userId` | `Integer` | ç”¨æˆ·ID |
| `position` | `Byte` | èŒä½ï¼ˆ1=ç®¡ç†å‘˜, 2=é¡¹ç›®ç»ç†, 3=æ™®é€šå‘˜å·¥ï¼‰ |
| `employeeName` | `String` | ç”¨æˆ·å§“å |

**å¤±è´¥å“åº”** (401):
```json
"Password not match"
```
æˆ–
```json
"User not found"
```

### **å‰ç«¯å¤„ç†**

```javascript
async function login(phone, password) {
  try {
    const response = await fetch('/auth/login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ phone, password })
    });
    
    if (response.ok) {
      const data = await response.json();
      
      // âœ… æ­¥éª¤1: ä¿å­˜ Token åˆ°æœ¬åœ°å­˜å‚¨
      localStorage.setItem('accessToken', data.accessToken);
      localStorage.setItem('refreshToken', data.refreshToken);
      localStorage.setItem('userId', data.userId);
      localStorage.setItem('position', data.position);
      localStorage.setItem('employeeName', data.employeeName);
      
      console.log('âœ… ç™»å½•æˆåŠŸ:', data.employeeName);
      
      // âœ… æ­¥éª¤2: ç«‹å³å»ºç«‹ SSE è¿æ¥
      await initSSE();
      
      // âœ… æ­¥éª¤3: è·³è½¬åˆ°ä¸»é¡µ
      navigateToHome();
      
      // âœ… æ­¥éª¤4: å¯åŠ¨ Token åˆ·æ–°å®šæ—¶å™¨
      startTokenRefreshTimer();
      
      return data;
    } else {
      const error = await response.text();
      console.error('âŒ ç™»å½•å¤±è´¥:', error);
      alert('ç™»å½•å¤±è´¥: ' + error);
    }
    
  } catch (error) {
    console.error('âŒ ç½‘ç»œé”™è¯¯:', error);
    alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
  }
}
```

---

## æ¥å£2: å»ºç«‹ SSE è¿æ¥

### **æ¥å£ä¿¡æ¯**

- **URL**: `GET /notifications/stream`
- **åè®®**: Server-Sent Events (SSE)
- **è®¤è¯**: **å¿…é¡»**æºå¸¦ JWT Token
- **Content-Type**: `text/event-stream`

### **è°ƒç”¨æ—¶æœº**

- âœ… **ç™»å½•æˆåŠŸåç«‹å³è°ƒç”¨**ï¼ˆåœ¨æ­¥éª¤1ä¹‹åï¼‰
- âœ… åº”ç”¨ä»åå°æ¢å¤åˆ°å‰å°æ—¶
- âœ… SSE è¿æ¥æ–­å¼€åé‡è¿

### **âš ï¸ é‡è¦è¯´æ˜**

**å¿…é¡»åœ¨ç™»å½•æˆåŠŸåç«‹å³å»ºç«‹ SSE è¿æ¥ï¼Œå¦åˆ™æ— æ³•æ¥æ”¶å®æ—¶é€šçŸ¥ï¼**

### **è¯·æ±‚ç¤ºä¾‹**

```javascript
const eventSource = new EventSource('/notifications/stream', {
  headers: {
    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
  }
});
```

### **è¿”å›äº‹ä»¶**

#### **äº‹ä»¶1: `connected` - è¿æ¥æˆåŠŸ**

**è§¦å‘æ—¶æœº**: SSE è¿æ¥å»ºç«‹æˆåŠŸ

**æ•°æ®**:
```
"SSE connection established"
```

**å‰ç«¯å¤„ç†**:
```javascript
eventSource.addEventListener('connected', (event) => {
  console.log('âœ… SSE è¿æ¥å·²å»ºç«‹:', event.data);
});
```

---

#### **äº‹ä»¶2: `notification` - æ–°é€šçŸ¥æ¨é€**

**è§¦å‘æ—¶æœº**: 
- ç”¨æˆ·ä¸Šçº¿æ—¶ï¼Œæ¨é€æ‰€æœ‰æœªæ¥æ”¶çš„é€šçŸ¥ï¼ˆNOT_RECEIVED çŠ¶æ€ï¼‰
- ç”¨æˆ·åœ¨çº¿æ—¶ï¼Œå®æ—¶æ¨é€æ–°é€šçŸ¥

**æ•°æ®æ ¼å¼**:
```json
{
  "noticeId": 123,
  "title": "ä»»åŠ¡åˆ†é…",
  "content": "æ‚¨è¢«åˆ†é…äº†æ–°ä»»åŠ¡: å®Œæˆé¡¹ç›®æ–‡æ¡£",
  "senderName": "å¼ ä¸‰",
  "createdTime": "2025-11-18T15:30:00",
  "status": "æœªæ¥æ”¶",
  "relatedId": 456
}
```

**å‰ç«¯å¤„ç†**:
```javascript
eventSource.addEventListener('notification', (event) => {
  const notice = JSON.parse(event.data);
  console.log('ğŸ“¥ æ”¶åˆ°é€šçŸ¥:', notice);
  
  // 1. æ˜¾ç¤ºé€šçŸ¥
  displayNotification(notice);
  
  // 2. åŠ å…¥å¾…ç¡®è®¤é˜Ÿåˆ—
  pendingConfirmNotices.add(notice.noticeId);
  
  // 3. å»¶è¿Ÿæ‰¹é‡ç¡®è®¤
  scheduleBatchConfirm();
});
```

---

#### **äº‹ä»¶3: `heartbeat` - å¿ƒè·³æ£€æµ‹**

**è§¦å‘æ—¶æœº**: æ¯ 30 ç§’ä¸€æ¬¡

**æ•°æ®**: `"ping"`

**å‰ç«¯å¤„ç†**:
```javascript
eventSource.addEventListener('heartbeat', (event) => {
  console.log('ğŸ’“ å¿ƒè·³:', event.data);
});
```

---

### **å®Œæ•´ SSE è¿æ¥ä»£ç **

```javascript
let eventSource = null;

async function initSSE() {
  const token = localStorage.getItem('accessToken');
  if (!token) {
    console.error('âŒ æœªç™»å½•ï¼Œæ— æ³•å»ºç«‹ SSE è¿æ¥');
    return;
  }
  
  // å…³é—­æ—§è¿æ¥
  if (eventSource) {
    eventSource.close();
  }
  
  console.log('ğŸ“¡ æ­£åœ¨å»ºç«‹ SSE è¿æ¥...');
  
  eventSource = new EventSource('/notifications/stream', {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  
  // è¿æ¥æ‰“å¼€
  eventSource.onopen = () => {
    console.log('âœ… SSE è¿æ¥å·²å»ºç«‹');
  };
  
  // ç›‘å¬è¿æ¥æˆåŠŸäº‹ä»¶
  eventSource.addEventListener('connected', (event) => {
    console.log('âœ… æ”¶åˆ°è¿æ¥ç¡®è®¤:', event.data);
  });
  
  // ç›‘å¬é€šçŸ¥äº‹ä»¶
  eventSource.addEventListener('notification', handleNotification);
  
  // ç›‘å¬å¿ƒè·³äº‹ä»¶
  eventSource.addEventListener('heartbeat', (event) => {
    console.log('ğŸ’“ å¿ƒè·³:', event.data);
  });
  
  // è¿æ¥é”™è¯¯
  eventSource.onerror = (error) => {
    console.error('âŒ SSE è¿æ¥é”™è¯¯:', error);
    
    // è‡ªåŠ¨é‡è¿ï¼ˆ3ç§’åï¼‰
    setTimeout(() => {
      console.log('ğŸ”„ å°è¯•é‡æ–°è¿æ¥ SSE...');
      initSSE();
    }, 3000);
  };
}

// å¤„ç†é€šçŸ¥
function handleNotification(event) {
  try {
    const notice = JSON.parse(event.data);
    console.log('ğŸ“¥ æ”¶åˆ°é€šçŸ¥:', notice);
    
    // 1. æ˜¾ç¤ºé€šçŸ¥
    displayNotification(notice);
    
    // 2. åŠ å…¥å¾…ç¡®è®¤é˜Ÿåˆ—
    pendingConfirmNotices.add(notice.noticeId);
    
    // 3. å»¶è¿Ÿæ‰¹é‡ç¡®è®¤
    scheduleBatchConfirm();
    
  } catch (error) {
    console.error('âŒ è§£æé€šçŸ¥å¤±è´¥:', error);
  }
}
```

---

## æ¥å£3: åˆ·æ–° Token

### **æ¥å£ä¿¡æ¯**

- **URL**: `POST /auth/refresh`
- **æ–¹æ³•**: `POST`
- **è®¤è¯**: æ— éœ€è®¤è¯ï¼ˆä½¿ç”¨ refreshTokenï¼‰
- **Content-Type**: `application/x-www-form-urlencoded`

### **è°ƒç”¨æ—¶æœºï¼ˆé‡è¦ï¼ï¼‰**

#### **æ—¶æœº1: å®šæ—¶ä¸»åŠ¨åˆ·æ–°ï¼ˆæ¨èï¼‰â­**

**æ—¶æœº**: ç™»å½•å **50 åˆ†é’Ÿ**è‡ªåŠ¨åˆ·æ–°

**åŸå› **: accessToken æœ‰æ•ˆæœŸä¸º 1 å°æ—¶ï¼Œæå‰ 10 åˆ†é’Ÿåˆ·æ–°å¯ä»¥é¿å… Token è¿‡æœŸå¯¼è‡´è¯·æ±‚å¤±è´¥

**å®ç°æ–¹å¼**:
```javascript
// ç™»å½•æˆåŠŸåå¯åŠ¨å®šæ—¶å™¨
function startTokenRefreshTimer() {
  // æ¯ 50 åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡
  setInterval(() => {
    console.log('ğŸ”„ å®šæ—¶åˆ·æ–° Token...');
    refreshToken();
  }, 50 * 60 * 1000);  // 50 åˆ†é’Ÿ
}
```

**ä¼˜ç‚¹**: 
- âœ… ç”¨æˆ·æ— æ„ŸçŸ¥
- âœ… é¿å…è¯·æ±‚å¤±è´¥
- âœ… ä¿æŒç™»å½•çŠ¶æ€

---

#### **æ—¶æœº2: æ”¶åˆ° 401 é”™è¯¯æ—¶ï¼ˆè¢«åŠ¨åˆ·æ–°ï¼‰**

**æ—¶æœº**: ä»»ä½•æ¥å£è¿”å› **401 Unauthorized** é”™è¯¯

**åç«¯è¿”å›çš„é”™è¯¯æ ¼å¼**:
```json
{
  "error": "Token æ— æ•ˆæˆ–å·²è¿‡æœŸ"
}
```
æˆ–
```json
{
  "error": "Token ä¸èƒ½ä¸ºç©º"
}
```

**å‰ç«¯å¤„ç†æµç¨‹**:
```javascript
async function fetchWithAuth(url, options = {}) {
  const token = localStorage.getItem('accessToken');
  
  options.headers = {
    ...options.headers,
    'Authorization': `Bearer ${token}`
  };
  
  const response = await fetch(url, options);
  
  // âš ï¸ æ”¶åˆ° 401 é”™è¯¯ï¼Œè¯´æ˜ Token è¿‡æœŸ
  if (response.status === 401) {
    console.log('âš ï¸ æ”¶åˆ° 401 é”™è¯¯ï¼ŒToken å·²è¿‡æœŸï¼Œå°è¯•åˆ·æ–°...');
    
    // 1. è°ƒç”¨åˆ·æ–°æ¥å£
    const refreshSuccess = await refreshToken();
    
    if (refreshSuccess) {
      // 2. åˆ·æ–°æˆåŠŸï¼Œé‡è¯•åŸè¯·æ±‚
      const newToken = localStorage.getItem('accessToken');
      options.headers['Authorization'] = `Bearer ${newToken}`;
      return fetch(url, options);
    } else {
      // 3. åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
      console.error('âŒ Token åˆ·æ–°å¤±è´¥ï¼Œéœ€è¦é‡æ–°ç™»å½•');
      logout();
      throw new Error('Token åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
    }
  }
  
  return response;
}
```

**è§¦å‘åœºæ™¯**:
- Token å·²è¿‡æœŸï¼ˆè¶…è¿‡ 1 å°æ—¶ï¼‰
- Token æ ¼å¼é”™è¯¯
- Token ç­¾åéªŒè¯å¤±è´¥
- ç”¨æˆ·åœ¨å…¶ä»–è®¾å¤‡ç™»å½•ï¼ˆå¦‚æœåç«¯å®ç°äº†å•ç‚¹ç™»å½•ï¼‰

---

#### **æ—¶æœº3: SSE è¿æ¥å¤±è´¥æ—¶**

**æ—¶æœº**: SSE è¿æ¥è¿”å› **401 é”™è¯¯**

**ç°è±¡**:
```javascript
eventSource.onerror = (error) => {
  console.error('âŒ SSE è¿æ¥é”™è¯¯:', error);
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯ 401 é”™è¯¯
  if (error.target.readyState === EventSource.CLOSED) {
    console.log('âš ï¸ SSE è¿æ¥å…³é—­ï¼Œå¯èƒ½æ˜¯ Token è¿‡æœŸ');
    
    // åˆ·æ–° Token
    refreshToken().then(() => {
      // é‡æ–°å»ºç«‹ SSE è¿æ¥
      initSSE();
    });
  }
};
```

---

#### **æ—¶æœº4: åº”ç”¨ä»åå°æ¢å¤æ—¶ï¼ˆå¯é€‰ï¼‰**

**æ—¶æœº**: åº”ç”¨ä»åå°æ¢å¤åˆ°å‰å°ï¼Œä¸” Token å¿«è¿‡æœŸ

**å®ç°æ–¹å¼**:
```javascript
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    console.log('ğŸ“± åº”ç”¨æ¢å¤åˆ°å‰å°');
    
    // æ£€æŸ¥ Token æ˜¯å¦å¿«è¿‡æœŸ
    const loginTime = localStorage.getItem('loginTime');
    if (loginTime) {
      const elapsed = Date.now() - parseInt(loginTime);
      
      // å¦‚æœè·ç¦»ç™»å½•å·²ç»è¶…è¿‡ 50 åˆ†é’Ÿï¼Œåˆ·æ–° Token
      if (elapsed > 50 * 60 * 1000) {
        console.log('ğŸ”„ Token å¿«è¿‡æœŸï¼Œåˆ·æ–°...');
        refreshToken();
      }
    }
  }
});
```

---

### **âš ï¸ é‡è¦è¯´æ˜**

1. **ä¼˜å…ˆä½¿ç”¨å®šæ—¶ä¸»åŠ¨åˆ·æ–°**ï¼šé¿å… Token è¿‡æœŸå¯¼è‡´è¯·æ±‚å¤±è´¥
2. **è¢«åŠ¨åˆ·æ–°ä½œä¸ºå…œåº•**ï¼šå¤„ç†æ„å¤–æƒ…å†µï¼ˆå¦‚ç”¨æˆ·é•¿æ—¶é—´æœªæ“ä½œï¼‰
3. **åˆ·æ–°åå¿…é¡»é‡æ–°å»ºç«‹ SSE è¿æ¥**ï¼šSSE è¿æ¥ä½¿ç”¨çš„æ˜¯æ—§ Token
4. **åˆ·æ–°å¤±è´¥å¿…é¡»è·³è½¬ç™»å½•é¡µ**ï¼šrefreshToken ä¹Ÿè¿‡æœŸäº†ï¼ˆ7å¤©ï¼‰

### **è¯·æ±‚å‚æ•°**

```
POST /auth/refresh?refreshToken={refreshToken}
```

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `refreshToken` | `String` | æ˜¯ | ç™»å½•æ—¶è¿”å›çš„ refreshToken |

### **è¿”å›æ•°æ®**

**æˆåŠŸå“åº”** (200):
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "userId": 123,
  "position": 1,
  "employeeName": "å¼ ä¸‰"
}
```

**å¤±è´¥å“åº”** (401):
```json
{
  "error": "Refresh token invalid or expired"
}
```

### **å‰ç«¯å¤„ç†**

```javascript
async function refreshToken() {
  const refreshToken = localStorage.getItem('refreshToken');
  if (!refreshToken) {
    console.error('âŒ æ²¡æœ‰ refreshTokenï¼Œéœ€è¦é‡æ–°ç™»å½•');
    logout();
    return;
  }
  
  try {
    const response = await fetch(`/auth/refresh?refreshToken=${refreshToken}`, {
      method: 'POST'
    });
    
    if (response.ok) {
      const data = await response.json();
      
      // æ›´æ–° Token
      localStorage.setItem('accessToken', data.accessToken);
      localStorage.setItem('refreshToken', data.refreshToken);
      
      console.log('âœ… Token åˆ·æ–°æˆåŠŸ');
      
      // é‡æ–°å»ºç«‹ SSE è¿æ¥ï¼ˆä½¿ç”¨æ–° Tokenï¼‰
      await initSSE();
      
      return data;
    } else {
      console.error('âŒ Token åˆ·æ–°å¤±è´¥ï¼Œéœ€è¦é‡æ–°ç™»å½•');
      logout();
    }
    
  } catch (error) {
    console.error('âŒ ç½‘ç»œé”™è¯¯:', error);
  }
}

// å¯åŠ¨å®šæ—¶åˆ·æ–°ï¼ˆç™»å½•åè°ƒç”¨ï¼‰
function startTokenRefreshTimer() {
  // æ¯ 50 åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ï¼ˆToken æœ‰æ•ˆæœŸ 1 å°æ—¶ï¼‰
  setInterval(() => {
    console.log('ğŸ”„ å®šæ—¶åˆ·æ–° Token...');
    refreshToken();
  }, 50 * 60 * 1000);
}
```

---

## å®Œæ•´å‰ç«¯å®ç°ç¤ºä¾‹

### **1. ç™»å½•é¡µé¢**

```javascript
// ========== ç™»å½•å‡½æ•° ==========
async function handleLogin() {
  const phone = document.getElementById('phone').value;
  const password = document.getElementById('password').value;
  
  if (!phone || !password) {
    alert('è¯·è¾“å…¥æ‰‹æœºå·å’Œå¯†ç ');
    return;
  }
  
  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  showLoading('æ­£åœ¨ç™»å½•...');
  
  try {
    // æ­¥éª¤1: è°ƒç”¨ç™»å½•æ¥å£
    const response = await fetch('/auth/login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ phone, password })
    });
    
    if (response.ok) {
      const data = await response.json();
      
      // æ­¥éª¤2: ä¿å­˜ Token
      localStorage.setItem('accessToken', data.accessToken);
      localStorage.setItem('refreshToken', data.refreshToken);
      localStorage.setItem('userId', data.userId);
      localStorage.setItem('position', data.position);
      localStorage.setItem('employeeName', data.employeeName);
      
      console.log('âœ… ç™»å½•æˆåŠŸ:', data.employeeName);
      
      // æ­¥éª¤3: å»ºç«‹ SSE è¿æ¥
      showLoading('æ­£åœ¨å»ºç«‹é€šçŸ¥è¿æ¥...');
      await initSSE();
      
      // æ­¥éª¤4: å¯åŠ¨ Token åˆ·æ–°å®šæ—¶å™¨
      startTokenRefreshTimer();
      
      // æ­¥éª¤5: è·³è½¬åˆ°ä¸»é¡µ
      hideLoading();
      window.location.href = '/home';
      
    } else {
      const error = await response.text();
      hideLoading();
      alert('ç™»å½•å¤±è´¥: ' + error);
    }
    
  } catch (error) {
    hideLoading();
    console.error('âŒ ç½‘ç»œé”™è¯¯:', error);
    alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
  }
}

// ========== é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€ ==========
window.addEventListener('DOMContentLoaded', () => {
  const token = localStorage.getItem('accessToken');
  
  if (token) {
    // å·²ç™»å½•ï¼Œå»ºç«‹ SSE è¿æ¥
    console.log('âœ… æ£€æµ‹åˆ°å·²ç™»å½•ï¼Œå»ºç«‹ SSE è¿æ¥');
    initSSE();
    startTokenRefreshTimer();
  } else {
    // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•é¡µé¢
    console.log('âš ï¸ æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•');
  }
});
```

---

### **2. åº”ç”¨å¯åŠ¨æµç¨‹**

```javascript
// ========== åº”ç”¨åˆå§‹åŒ– ==========
async function initApp() {
  console.log('ğŸš€ åº”ç”¨å¯åŠ¨...');
  
  // 1. æ£€æŸ¥æ˜¯å¦æœ‰ Token
  const accessToken = localStorage.getItem('accessToken');
  const refreshToken = localStorage.getItem('refreshToken');
  
  if (!accessToken || !refreshToken) {
    console.log('âš ï¸ æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
    navigateToLogin();
    return;
  }
  
  // 2. éªŒè¯ Token æ˜¯å¦æœ‰æ•ˆ
  const isValid = await validateToken(accessToken);
  
  if (!isValid) {
    console.log('âš ï¸ accessToken å·²è¿‡æœŸï¼Œå°è¯•ä½¿ç”¨ refreshToken åˆ·æ–°...');
    
    // â­ é‡è¦ï¼šä¼˜å…ˆå°è¯•åˆ·æ–° Tokenï¼Œè€Œä¸æ˜¯ç›´æ¥è·³è½¬ç™»å½•é¡µ
    const success = await refreshTokens();
    
    if (success) {
      console.log('âœ… Token åˆ·æ–°æˆåŠŸï¼Œç»§ç»­å¯åŠ¨åº”ç”¨');
    } else {
      console.log('âŒ refreshToken ä¹Ÿå·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°ç™»å½•');
      // æ¸…é™¤è¿‡æœŸçš„ Token
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      navigateToLogin();
      return;
    }
  }
  
  // 3. å»ºç«‹ SSE è¿æ¥
  console.log('ğŸ“¡ å»ºç«‹ SSE è¿æ¥...');
  await initSSE();
  
  // 4. å¯åŠ¨ Token åˆ·æ–°å®šæ—¶å™¨
  startTokenRefreshTimer();
  
  // 5. åŠ è½½ä¸»é¡µæ•°æ®
  loadHomeData();
  
  console.log('âœ… åº”ç”¨å¯åŠ¨å®Œæˆ');
}

// éªŒè¯ Token æ˜¯å¦æœ‰æ•ˆ
async function validateToken(token) {
  try {
    const response = await fetch('/notices/check', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    return response.ok;
  } catch (error) {
    return false;
  }
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', initApp);
```

---

### **âš ï¸ é‡è¦ï¼šå¤„ç†è¿‡æœŸ Token çš„æœ€ä½³å®è·µ**

#### **åœºæ™¯ï¼šç”¨æˆ·é•¿æ—¶é—´æœªä½¿ç”¨åº”ç”¨**

å½“ç”¨æˆ·é•¿æ—¶é—´ï¼ˆè¶…è¿‡ 1 å°æ—¶ï¼‰æœªä½¿ç”¨åº”ç”¨æ—¶ï¼Œ`accessToken` ä¼šè¿‡æœŸã€‚æ­¤æ—¶åº”è¯¥ï¼š

1. **ä¼˜å…ˆå°è¯•åˆ·æ–° Token**ï¼ˆæ¨èï¼‰â­
2. åˆ·æ–°å¤±è´¥åå†è·³è½¬ç™»å½•é¡µ

#### **ä¸ºä»€ä¹ˆä¸ç›´æ¥è·³è½¬ç™»å½•é¡µï¼Ÿ**

| æ–¹æ¡ˆ | ç”¨æˆ·ä½“éªŒ | è¯´æ˜ |
|------|---------|------|
| âŒ ç›´æ¥è·³è½¬ç™»å½•é¡µ | å·® | ç”¨æˆ·éœ€è¦é‡æ–°è¾“å…¥è´¦å·å¯†ç  |
| âœ… å…ˆå°è¯•åˆ·æ–° Token | å¥½ | `refreshToken` æœ‰æ•ˆæœŸ 7 å¤©ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯ä»¥è‡ªåŠ¨æ¢å¤ç™»å½•çŠ¶æ€ |

#### **å®Œæ•´çš„ Token è¿‡æœŸå¤„ç†æµç¨‹**

```javascript
async function handleExpiredToken() {
  console.log('âš ï¸ æ£€æµ‹åˆ° Token è¿‡æœŸ');
  
  // 1. æ£€æŸ¥æ˜¯å¦æœ‰ refreshToken
  const refreshToken = localStorage.getItem('refreshToken');
  
  if (!refreshToken) {
    console.log('âŒ æ²¡æœ‰ refreshTokenï¼Œéœ€è¦é‡æ–°ç™»å½•');
    navigateToLogin();
    return false;
  }
  
  // 2. å°è¯•åˆ·æ–° Token
  console.log('ğŸ”„ å°è¯•ä½¿ç”¨ refreshToken åˆ·æ–°...');
  
  try {
    const response = await fetch(`/auth/refresh?refreshToken=${refreshToken}`, {
      method: 'POST'
    });
    
    if (response.ok) {
      const data = await response.json();
      
      // 3. ä¿å­˜æ–°çš„ Token
      localStorage.setItem('accessToken', data.accessToken);
      localStorage.setItem('refreshToken', data.refreshToken);
      localStorage.setItem('loginTime', Date.now().toString());
      
      console.log('âœ… Token åˆ·æ–°æˆåŠŸ');
      
      // 4. é‡æ–°å»ºç«‹ SSE è¿æ¥ï¼ˆä½¿ç”¨æ–° Tokenï¼‰
      await initSSE();
      
      return true;
    } else {
      console.log('âŒ refreshToken ä¹Ÿå·²è¿‡æœŸï¼ˆè¶…è¿‡ 7 å¤©ï¼‰');
      
      // 5. æ¸…é™¤è¿‡æœŸçš„ Token
      localStorage.removeItem('accessToken');
      localStorage.removeItem('refreshToken');
      
      // 6. è·³è½¬åˆ°ç™»å½•é¡µ
      navigateToLogin();
      
      return false;
    }
    
  } catch (error) {
    console.error('âŒ åˆ·æ–° Token å¤±è´¥:', error);
    navigateToLogin();
    return false;
  }
}
```

#### **åº”ç”¨å¯åŠ¨æ—¶çš„æ£€æŸ¥é€»è¾‘**

```javascript
async function initApp() {
  console.log('ğŸš€ åº”ç”¨å¯åŠ¨...');
  
  const accessToken = localStorage.getItem('accessToken');
  const refreshToken = localStorage.getItem('refreshToken');
  
  // æƒ…å†µ1: æ²¡æœ‰ä»»ä½• Token â†’ ç›´æ¥è·³è½¬ç™»å½•é¡µ
  if (!accessToken && !refreshToken) {
    console.log('âš ï¸ æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
    navigateToLogin();
    return;
  }
  
  // æƒ…å†µ2: æœ‰ refreshToken ä½†æ²¡æœ‰ accessToken â†’ å°è¯•åˆ·æ–°
  if (!accessToken && refreshToken) {
    console.log('âš ï¸ accessToken ç¼ºå¤±ï¼Œå°è¯•åˆ·æ–°...');
    const success = await handleExpiredToken();
    if (!success) return;
  }
  
  // æƒ…å†µ3: æœ‰ accessToken â†’ éªŒè¯æ˜¯å¦æœ‰æ•ˆ
  if (accessToken) {
    const isValid = await validateToken(accessToken);
    
    if (!isValid) {
      console.log('âš ï¸ accessToken å·²è¿‡æœŸï¼Œå°è¯•åˆ·æ–°...');
      const success = await handleExpiredToken();
      if (!success) return;
    }
  }
  
  // Token æœ‰æ•ˆï¼Œç»§ç»­å¯åŠ¨åº”ç”¨
  console.log('âœ… Token éªŒè¯é€šè¿‡ï¼Œå¯åŠ¨åº”ç”¨');
  await initSSE();
  startTokenRefreshTimer();
  loadHomeData();
}
```

#### **æœ€ä½³å®è·µæ€»ç»“**

| åœºæ™¯ | å¤„ç†æ–¹å¼ | ç”¨æˆ·ä½“éªŒ |
|------|---------|---------|
| **accessToken è¿‡æœŸï¼ŒrefreshToken æœ‰æ•ˆ** | è‡ªåŠ¨åˆ·æ–° Token | âœ… æ— æ„ŸçŸ¥ï¼Œè‡ªåŠ¨æ¢å¤ |
| **accessToken å’Œ refreshToken éƒ½è¿‡æœŸ** | è·³è½¬ç™»å½•é¡µ | âš ï¸ éœ€è¦é‡æ–°ç™»å½• |
| **æ²¡æœ‰ä»»ä½• Token** | è·³è½¬ç™»å½•é¡µ | âš ï¸ éœ€è¦ç™»å½• |
| **ç½‘ç»œé”™è¯¯å¯¼è‡´åˆ·æ–°å¤±è´¥** | æç¤ºç”¨æˆ·ï¼Œç¨åé‡è¯• | âš ï¸ å¯é€‰æ‹©é‡è¯•æˆ–ç™»å½• |

#### **ä¿å­˜ç™»å½•æ—¶é—´ä»¥ä¼˜åŒ–æ£€æŸ¥**

```javascript
// ç™»å½•æˆåŠŸåä¿å­˜æ—¶é—´
async function login(phone, password) {
  // ... ç™»å½•é€»è¾‘ ...
  
  if (response.ok) {
    const data = await response.json();
    
    localStorage.setItem('accessToken', data.accessToken);
    localStorage.setItem('refreshToken', data.refreshToken);
    localStorage.setItem('loginTime', Date.now().toString()); // â­ ä¿å­˜ç™»å½•æ—¶é—´
    
    // ...
  }
}

// åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ·æ–°
async function initApp() {
  const loginTime = localStorage.getItem('loginTime');
  
  if (loginTime) {
    const elapsed = Date.now() - parseInt(loginTime);
    
    // å¦‚æœè·ç¦»ç™»å½•è¶…è¿‡ 50 åˆ†é’Ÿï¼Œä¸»åŠ¨åˆ·æ–° Token
    if (elapsed > 50 * 60 * 1000) {
      console.log('âš ï¸ Token å¿«è¿‡æœŸï¼Œä¸»åŠ¨åˆ·æ–°...');
      await handleExpiredToken();
    }
  }
  
  // ç»§ç»­å¯åŠ¨æµç¨‹...
}
```

**æ¨èé…ç½®**ï¼š
- âœ… åº”ç”¨å¯åŠ¨æ—¶ä¼˜å…ˆå°è¯•åˆ·æ–° Token
- âœ… åˆ·æ–°å¤±è´¥åå†è·³è½¬ç™»å½•é¡µ
- âœ… ä¿å­˜ç™»å½•æ—¶é—´ï¼Œæå‰åˆ·æ–° Token
- âœ… ç»™ç”¨æˆ·æä¾›"é‡è¯•"é€‰é¡¹ï¼Œè€Œä¸æ˜¯ç›´æ¥è·³è½¬ç™»å½•é¡µ

---

### **3. é€€å‡ºç™»å½•**

```javascript
function logout() {
  console.log('ğŸ‘‹ ç”¨æˆ·é€€å‡ºç™»å½•');
  
  // 1. å…³é—­ SSE è¿æ¥
  if (eventSource) {
    eventSource.close();
    eventSource = null;
  }
  
  // 2. æ¸…é™¤æœ¬åœ°å­˜å‚¨
  localStorage.removeItem('accessToken');
  localStorage.removeItem('refreshToken');
  localStorage.removeItem('userId');
  localStorage.removeItem('position');
  localStorage.removeItem('employeeName');
  
  // 3. è·³è½¬åˆ°ç™»å½•é¡µé¢
  window.location.href = '/login';
}
```

---

## âš ï¸ é‡è¦ï¼šä½•æ—¶æ–­å¼€ SSE è¿æ¥ä»¥èŠ‚çœåç«¯èµ„æº

### **ä¸ºä»€ä¹ˆè¦ä¸»åŠ¨æ–­å¼€ SSE è¿æ¥ï¼Ÿ**

SSEï¼ˆServer-Sent Eventsï¼‰æ˜¯**é•¿è¿æ¥**ï¼Œæ¯ä¸ªè¿æ¥ä¼š**æŒç»­å ç”¨ä¸€ä¸ª Tomcat å·¥ä½œçº¿ç¨‹**ã€‚å¦‚æœä¸åŠæ—¶æ–­å¼€ï¼Œä¼šå¯¼è‡´ï¼š
- âŒ æµªè´¹æœåŠ¡å™¨çº¿ç¨‹èµ„æº
- âŒ å½±å“å…¶ä»–ç”¨æˆ·çš„è¯·æ±‚å¤„ç†
- âŒ å¯èƒ½å¯¼è‡´çº¿ç¨‹æ± è€—å°½

**åç«¯é…ç½®**ï¼š
- SSE è¿æ¥è¶…æ—¶ï¼š**30 åˆ†é’Ÿ**
- Tomcat æœ€å¤§çº¿ç¨‹æ•°ï¼š**150**

---

### **å¿…é¡»æ–­å¼€ SSE è¿æ¥çš„åœºæ™¯**

| åœºæ™¯ | ä½•æ—¶æ–­å¼€ | åŸå›  | ä¼˜å…ˆçº§ |
|------|---------|------|--------|
| **ç”¨æˆ·é€€å‡ºç™»å½•** | ç«‹å³æ–­å¼€ | ç”¨æˆ·å·²é€€å‡ºï¼Œä¸éœ€è¦æ¥æ”¶é€šçŸ¥ | â­â­â­â­â­ |
| **åº”ç”¨è¿›å…¥åå°** | å»¶è¿Ÿ 5 åˆ†é’Ÿåæ–­å¼€ | ç”¨æˆ·å¯èƒ½å¾ˆå¿«è¿”å›ï¼Œå»¶è¿Ÿæ–­å¼€é¿å…é¢‘ç¹é‡è¿ | â­â­â­â­ |
| **Token è¿‡æœŸä¸”åˆ·æ–°å¤±è´¥** | ç«‹å³æ–­å¼€ | æ— æ³•ç»§ç»­è®¤è¯ï¼Œè¿æ¥æ— æ•ˆ | â­â­â­â­â­ |
| **ç½‘ç»œæ–­å¼€** | è‡ªåŠ¨æ–­å¼€ | è¿æ¥å·²å¤±æ•ˆ | â­â­â­â­â­ |
| **é¡µé¢å…³é—­/åˆ·æ–°** | è‡ªåŠ¨æ–­å¼€ | æµè§ˆå™¨ä¼šè‡ªåŠ¨å…³é—­è¿æ¥ | â­â­â­â­â­ |
| **ç”¨æˆ·åˆ‡æ¢è´¦å·** | ç«‹å³æ–­å¼€æ—§è¿æ¥ | é¿å…æ¥æ”¶åˆ°å…¶ä»–ç”¨æˆ·çš„é€šçŸ¥ | â­â­â­â­â­ |

---

### **åœºæ™¯1: ç”¨æˆ·é€€å‡ºç™»å½•ï¼ˆå·²å®ç°ï¼‰**

```javascript
function logout() {
  console.log('ğŸ‘‹ ç”¨æˆ·é€€å‡ºç™»å½•');
  
  // â­ é‡è¦ï¼šç«‹å³å…³é—­ SSE è¿æ¥
  if (eventSource) {
    eventSource.close();
    eventSource = null;
    console.log('âœ… SSE è¿æ¥å·²å…³é—­');
  }
  
  // æ¸…é™¤æœ¬åœ°å­˜å‚¨
  localStorage.clear();
  
  // è·³è½¬åˆ°ç™»å½•é¡µé¢
  window.location.href = '/login';
}
```

---

### **åœºæ™¯2: åº”ç”¨è¿›å…¥åå°ï¼ˆæ¨èå®ç°ï¼‰â­**

**ç­–ç•¥**ï¼šå»¶è¿Ÿ 5 åˆ†é’Ÿåæ–­å¼€ï¼Œé¿å…é¢‘ç¹é‡è¿

```javascript
let backgroundTimer = null;

// ç›‘å¬åº”ç”¨è¿›å…¥åå°
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    console.log('âš ï¸ åº”ç”¨è¿›å…¥åå°');
    
    // 5 åˆ†é’Ÿåæ–­å¼€ SSE è¿æ¥
    backgroundTimer = setTimeout(() => {
      if (eventSource) {
        console.log('âš ï¸ åº”ç”¨åå°è¿è¡Œè¶…è¿‡ 5 åˆ†é’Ÿï¼Œæ–­å¼€ SSE è¿æ¥ä»¥èŠ‚çœèµ„æº');
        eventSource.close();
        eventSource = null;
      }
    }, 5 * 60 * 1000);  // 5 åˆ†é’Ÿ
    
  } else {
    console.log('âœ… åº”ç”¨è¿”å›å‰å°');
    
    // å–æ¶ˆæ–­å¼€è®¡æ—¶å™¨
    if (backgroundTimer) {
      clearTimeout(backgroundTimer);
      backgroundTimer = null;
    }
    
    // æ£€æŸ¥ SSE è¿æ¥æ˜¯å¦å­˜åœ¨
    if (!eventSource || eventSource.readyState === EventSource.CLOSED) {
      console.log('ğŸ”„ é‡æ–°å»ºç«‹ SSE è¿æ¥');
      initSSE();
    }
  }
});
```

**ä¸ºä»€ä¹ˆå»¶è¿Ÿ 5 åˆ†é’Ÿï¼Ÿ**
- âœ… ç”¨æˆ·å¯èƒ½å¾ˆå¿«è¿”å›ï¼ˆå¦‚åˆ‡æ¢åº”ç”¨æŸ¥çœ‹æ¶ˆæ¯ï¼‰
- âœ… é¿å…é¢‘ç¹æ–­å¼€å’Œé‡è¿
- âœ… å¹³è¡¡ç”¨æˆ·ä½“éªŒå’Œèµ„æºæ¶ˆè€—

---

### **åœºæ™¯3: Token è¿‡æœŸä¸”åˆ·æ–°å¤±è´¥**

```javascript
async function handleExpiredToken() {
  console.log('âš ï¸ æ£€æµ‹åˆ° Token è¿‡æœŸ');
  
  // å°è¯•åˆ·æ–° Token
  const success = await refreshTokens();
  
  if (!success) {
    console.log('âŒ Token åˆ·æ–°å¤±è´¥ï¼Œæ–­å¼€ SSE è¿æ¥');
    
    // â­ é‡è¦ï¼šç«‹å³æ–­å¼€ SSE è¿æ¥
    if (eventSource) {
      eventSource.close();
      eventSource = null;
    }
    
    // è·³è½¬åˆ°ç™»å½•é¡µ
    navigateToLogin();
  }
}
```

---

### **åœºæ™¯4: ç½‘ç»œæ–­å¼€ï¼ˆè‡ªåŠ¨å¤„ç†ï¼‰**

```javascript
// ç›‘å¬ç½‘ç»œçŠ¶æ€
window.addEventListener('offline', () => {
  console.log('âŒ ç½‘ç»œå·²æ–­å¼€');
  
  // SSE è¿æ¥ä¼šè‡ªåŠ¨æ–­å¼€ï¼Œä½†å»ºè®®ä¸»åŠ¨å…³é—­
  if (eventSource) {
    eventSource.close();
    eventSource = null;
  }
});

window.addEventListener('online', () => {
  console.log('âœ… ç½‘ç»œå·²æ¢å¤');
  
  // é‡æ–°å»ºç«‹ SSE è¿æ¥
  initSSE();
});
```

---

### **åœºæ™¯5: é¡µé¢å…³é—­/åˆ·æ–°ï¼ˆè‡ªåŠ¨å¤„ç†ï¼‰**

æµè§ˆå™¨ä¼šè‡ªåŠ¨å…³é—­ SSE è¿æ¥ï¼Œä½†å»ºè®®åœ¨ `beforeunload` äº‹ä»¶ä¸­ä¸»åŠ¨å…³é—­ï¼š

```javascript
window.addEventListener('beforeunload', () => {
  console.log('âš ï¸ é¡µé¢å³å°†å…³é—­');
  
  // ä¸»åŠ¨å…³é—­ SSE è¿æ¥
  if (eventSource) {
    eventSource.close();
    eventSource = null;
  }
});
```

---

### **åœºæ™¯6: ç”¨æˆ·åˆ‡æ¢è´¦å·**

```javascript
async function switchAccount(newPhone, newPassword) {
  console.log('ğŸ”„ åˆ‡æ¢è´¦å·');
  
  // 1. æ–­å¼€æ—§çš„ SSE è¿æ¥
  if (eventSource) {
    eventSource.close();
    eventSource = null;
    console.log('âœ… å·²æ–­å¼€æ—§è´¦å·çš„ SSE è¿æ¥');
  }
  
  // 2. æ¸…é™¤æ—§çš„ Token
  localStorage.clear();
  
  // 3. ç™»å½•æ–°è´¦å·
  await login(newPhone, newPassword);
  
  // 4. å»ºç«‹æ–°çš„ SSE è¿æ¥
  await initSSE();
}
```

---

### **å®Œæ•´çš„ SSE ç”Ÿå‘½å‘¨æœŸç®¡ç†**

```javascript
class SSEManager {
  constructor() {
    this.eventSource = null;
    this.backgroundTimer = null;
    this.reconnectAttempts = 0;
    this.maxReconnectAttempts = 5;
  }
  
  // å»ºç«‹è¿æ¥
  async connect() {
    const token = localStorage.getItem('accessToken');
    if (!token) {
      console.error('âŒ æœªç™»å½•ï¼Œæ— æ³•å»ºç«‹ SSE è¿æ¥');
      return;
    }
    
    // å…³é—­æ—§è¿æ¥
    this.disconnect();
    
    console.log('ğŸ“¡ æ­£åœ¨å»ºç«‹ SSE è¿æ¥...');
    
    this.eventSource = new EventSource('/notifications/stream', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });
    
    this.setupEventListeners();
  }
  
  // æ–­å¼€è¿æ¥
  disconnect() {
    if (this.eventSource) {
      this.eventSource.close();
      this.eventSource = null;
      console.log('âœ… SSE è¿æ¥å·²æ–­å¼€');
    }
    
    // æ¸…é™¤åå°è®¡æ—¶å™¨
    if (this.backgroundTimer) {
      clearTimeout(this.backgroundTimer);
      this.backgroundTimer = null;
    }
  }
  
  // è®¾ç½®äº‹ä»¶ç›‘å¬
  setupEventListeners() {
    this.eventSource.addEventListener('connected', (event) => {
      console.log('âœ… SSE è¿æ¥å·²å»ºç«‹');
      this.reconnectAttempts = 0;  // é‡ç½®é‡è¿æ¬¡æ•°
    });
    
    this.eventSource.addEventListener('notification', (event) => {
      const notice = JSON.parse(event.data);
      console.log('ğŸ“¥ æ”¶åˆ°é€šçŸ¥:', notice);
      // å¤„ç†é€šçŸ¥...
    });
    
    this.eventSource.onerror = (error) => {
      console.error('âŒ SSE è¿æ¥é”™è¯¯:', error);
      this.handleError();
    };
  }
  
  // å¤„ç†é”™è¯¯å’Œé‡è¿
  async handleError() {
    this.disconnect();
    
    if (this.reconnectAttempts >= this.maxReconnectAttempts) {
      console.error('âŒ SSE é‡è¿å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œåœæ­¢é‡è¿');
      return;
    }
    
    this.reconnectAttempts++;
    const delay = Math.min(1000 * Math.pow(2, this.reconnectAttempts), 16000);
    
    console.log(`ğŸ”„ ${delay}ms åå°è¯•é‡è¿ (ç¬¬ ${this.reconnectAttempts} æ¬¡)`);
    
    setTimeout(() => {
      this.connect();
    }, delay);
  }
  
  // åº”ç”¨è¿›å…¥åå°
  onBackground() {
    console.log('âš ï¸ åº”ç”¨è¿›å…¥åå°');
    
    // 5 åˆ†é’Ÿåæ–­å¼€è¿æ¥
    this.backgroundTimer = setTimeout(() => {
      console.log('âš ï¸ åº”ç”¨åå°è¿è¡Œè¶…è¿‡ 5 åˆ†é’Ÿï¼Œæ–­å¼€ SSE è¿æ¥');
      this.disconnect();
    }, 5 * 60 * 1000);
  }
  
  // åº”ç”¨è¿”å›å‰å°
  onForeground() {
    console.log('âœ… åº”ç”¨è¿”å›å‰å°');
    
    // å–æ¶ˆæ–­å¼€è®¡æ—¶å™¨
    if (this.backgroundTimer) {
      clearTimeout(this.backgroundTimer);
      this.backgroundTimer = null;
    }
    
    // æ£€æŸ¥è¿æ¥çŠ¶æ€
    if (!this.eventSource || this.eventSource.readyState === EventSource.CLOSED) {
      console.log('ğŸ”„ é‡æ–°å»ºç«‹ SSE è¿æ¥');
      this.connect();
    }
  }
}

// å…¨å±€ SSE ç®¡ç†å™¨
const sseManager = new SSEManager();

// ç›‘å¬åº”ç”¨çŠ¶æ€
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    sseManager.onBackground();
  } else {
    sseManager.onForeground();
  }
});

// ç›‘å¬ç½‘ç»œçŠ¶æ€
window.addEventListener('offline', () => {
  console.log('âŒ ç½‘ç»œå·²æ–­å¼€');
  sseManager.disconnect();
});

window.addEventListener('online', () => {
  console.log('âœ… ç½‘ç»œå·²æ¢å¤');
  sseManager.connect();
});

// é¡µé¢å…³é—­æ—¶æ–­å¼€è¿æ¥
window.addEventListener('beforeunload', () => {
  sseManager.disconnect();
});
```

---

### **æœ€ä½³å®è·µæ€»ç»“**

| å®è·µ | è¯´æ˜ | å¥½å¤„ |
|------|------|------|
| **é€€å‡ºç™»å½•æ—¶ç«‹å³æ–­å¼€** | ç”¨æˆ·é€€å‡ºæ—¶è°ƒç”¨ `eventSource.close()` | é‡Šæ”¾æœåŠ¡å™¨èµ„æº |
| **åå° 5 åˆ†é’Ÿåæ–­å¼€** | åº”ç”¨è¿›å…¥åå° 5 åˆ†é’Ÿåè‡ªåŠ¨æ–­å¼€ | å¹³è¡¡ç”¨æˆ·ä½“éªŒå’Œèµ„æºæ¶ˆè€— |
| **Token å¤±æ•ˆæ—¶æ–­å¼€** | Token åˆ·æ–°å¤±è´¥åç«‹å³æ–­å¼€ | é¿å…æ— æ•ˆè¿æ¥å ç”¨èµ„æº |
| **ç½‘ç»œæ–­å¼€æ—¶æ–­å¼€** | ç›‘å¬ `offline` äº‹ä»¶ä¸»åŠ¨æ–­å¼€ | åŠæ—¶é‡Šæ”¾èµ„æº |
| **é¡µé¢å…³é—­æ—¶æ–­å¼€** | ç›‘å¬ `beforeunload` äº‹ä»¶æ–­å¼€ | ç¡®ä¿èµ„æºé‡Šæ”¾ |
| **ä½¿ç”¨ SSE ç®¡ç†å™¨** | å°è£… SSE ç”Ÿå‘½å‘¨æœŸç®¡ç† | ä»£ç æ›´æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤ |

---

### **èµ„æºæ¶ˆè€—å¯¹æ¯”**

| åœºæ™¯ | SSE è¿æ¥æ•° | å ç”¨çº¿ç¨‹æ•° | å½±å“ |
|------|-----------|-----------|------|
| **ä¸æ–­å¼€è¿æ¥** | 100 ä¸ªç”¨æˆ· | 100 ä¸ªçº¿ç¨‹ | âŒ åªå‰© 50 ä¸ªçº¿ç¨‹å¤„ç†å…¶ä»–è¯·æ±‚ |
| **åŠæ—¶æ–­å¼€è¿æ¥** | 50 ä¸ªåœ¨çº¿ç”¨æˆ· | 50 ä¸ªçº¿ç¨‹ | âœ… è¿˜æœ‰ 100 ä¸ªçº¿ç¨‹å¤„ç†å…¶ä»–è¯·æ±‚ |

**ç»“è®º**ï¼šåŠæ—¶æ–­å¼€ SSE è¿æ¥å¯ä»¥**èŠ‚çœ 50% çš„çº¿ç¨‹èµ„æº**ï¼

---

## åç«¯å¦‚ä½•å‘ŠçŸ¥å‰ç«¯ Token è¿‡æœŸ

### **æ–¹å¼1: HTTP çŠ¶æ€ç  401**

**æœ€å¸¸è§çš„æ–¹å¼**ï¼šåç«¯è¿”å› **401 Unauthorized** çŠ¶æ€ç 

#### **è§¦å‘åœºæ™¯**

| åœºæ™¯ | åç«¯æ£€æµ‹ä½ç½® | è¿”å›çŠ¶æ€ç  | è¿”å›å†…å®¹ |
|------|------------|-----------|---------|
| Token ä¸ºç©º | `JwtAuthFilter` | `401` | `{"error":"Token ä¸èƒ½ä¸ºç©º"}` |
| Token æ ¼å¼é”™è¯¯ | `JwtAuthFilter` | `401` | `{"error":"Token æ ¼å¼é”™è¯¯"}` |
| Token å·²è¿‡æœŸ | `JwtAuthFilter` | `401` | `{"error":"Token æ— æ•ˆæˆ–å·²è¿‡æœŸ"}` |
| Token ç­¾åæ— æ•ˆ | `JwtAuthFilter` | `401` | `{"error":"Token æ— æ•ˆæˆ–å·²è¿‡æœŸ"}` |

#### **åç«¯ä»£ç é€»è¾‘**

```java
// JwtAuthFilter.java

// 1. Token ä¸ºç©º
if (token == null || token.trim().isEmpty()) {
    response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);  // 401
    response.getWriter().write("{\"error\":\"Token ä¸èƒ½ä¸ºç©º\"}");
    return;
}

// 2. Token æ— æ•ˆæˆ–è¿‡æœŸ
if (!jwtUtil.validateToken(token)) {
    response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);  // 401
    response.getWriter().write("{\"error\":\"Token æ— æ•ˆæˆ–å·²è¿‡æœŸ\"}");
    return;
}

// 3. Token æ ¼å¼é”™è¯¯
if (userId == null) {
    response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);  // 401
    response.getWriter().write("{\"error\":\"Token æ ¼å¼é”™è¯¯\"}");
    return;
}
```

#### **å‰ç«¯æ£€æµ‹æ–¹å¼**

```javascript
// æ–¹å¼1: æ£€æŸ¥ HTTP çŠ¶æ€ç 
const response = await fetch('/notices/me/unread', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});

if (response.status === 401) {
  console.log('âš ï¸ åç«¯è¿”å› 401ï¼ŒToken å·²è¿‡æœŸ');
  
  // å°è¯•åˆ·æ–° Token
  const success = await refreshToken();
  if (!success) {
    // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•é¡µ
    logout();
  }
}
```

---

### **æ–¹å¼2: SSE è¿æ¥å…³é—­**

**SSE è¿æ¥ä¼šå› ä¸º Token è¿‡æœŸè€Œå…³é—­**

#### **è§¦å‘åœºæ™¯**

å½“ SSE è¿æ¥å»ºç«‹æ—¶ï¼Œå¦‚æœ Token æ— æ•ˆï¼š
- åç«¯è¿”å› 401 é”™è¯¯
- SSE è¿æ¥ç«‹å³å…³é—­
- `eventSource.readyState` å˜ä¸º `EventSource.CLOSED`

#### **å‰ç«¯æ£€æµ‹æ–¹å¼**

```javascript
eventSource.onerror = (error) => {
  console.error('âŒ SSE è¿æ¥é”™è¯¯:', error);
  
  // æ£€æŸ¥è¿æ¥çŠ¶æ€
  if (eventSource.readyState === EventSource.CLOSED) {
    console.log('âš ï¸ SSE è¿æ¥å·²å…³é—­ï¼Œå¯èƒ½æ˜¯ Token è¿‡æœŸ');
    
    // å°è¯•åˆ·æ–° Token
    refreshToken().then((success) => {
      if (success) {
        // åˆ·æ–°æˆåŠŸï¼Œé‡æ–°å»ºç«‹è¿æ¥
        initSSE();
      } else {
        // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•é¡µ
        logout();
      }
    });
  }
};
```

---

### **æ–¹å¼3: å“åº”ä½“ä¸­çš„é”™è¯¯ä¿¡æ¯**

**éƒ¨åˆ†æ¥å£å¯èƒ½åœ¨å“åº”ä½“ä¸­è¿”å›é”™è¯¯ä¿¡æ¯**

#### **ç¤ºä¾‹**

```json
{
  "error": "Token æ— æ•ˆæˆ–å·²è¿‡æœŸ",
  "code": "TOKEN_EXPIRED",
  "timestamp": "2025-11-18T16:00:00"
}
```

#### **å‰ç«¯æ£€æµ‹æ–¹å¼**

```javascript
const response = await fetch('/notices/me/unread', {
  headers: {
    'Authorization': `Bearer ${token}`
  }
});

if (response.status === 401) {
  const error = await response.json();
  
  if (error.error.includes('è¿‡æœŸ') || error.code === 'TOKEN_EXPIRED') {
    console.log('âš ï¸ Token å·²è¿‡æœŸ:', error.error);
    await refreshToken();
  }
}
```

---

### **å®Œæ•´çš„ Token è¿‡æœŸæ£€æµ‹å’Œå¤„ç†æµç¨‹**

```javascript
// å…¨å±€è¯·æ±‚æ‹¦æˆªå™¨
async function fetchWithAuth(url, options = {}) {
  const token = localStorage.getItem('accessToken');
  
  // 1. æ·»åŠ  Token åˆ°è¯·æ±‚å¤´
  options.headers = {
    ...options.headers,
    'Authorization': `Bearer ${token}`
  };
  
  // 2. å‘é€è¯·æ±‚
  const response = await fetch(url, options);
  
  // 3. æ£€æŸ¥æ˜¯å¦è¿”å› 401
  if (response.status === 401) {
    console.log('âš ï¸ æ”¶åˆ° 401 é”™è¯¯ï¼ŒToken å¯èƒ½å·²è¿‡æœŸ');
    
    // 4. å°è¯•è§£æé”™è¯¯ä¿¡æ¯
    try {
      const error = await response.json();
      console.log('é”™è¯¯è¯¦æƒ…:', error);
    } catch (e) {
      // æ— æ³•è§£æ JSONï¼Œå¯èƒ½æ˜¯çº¯æ–‡æœ¬
      const errorText = await response.text();
      console.log('é”™è¯¯è¯¦æƒ…:', errorText);
    }
    
    // 5. å°è¯•åˆ·æ–° Token
    const refreshSuccess = await refreshToken();
    
    if (refreshSuccess) {
      // 6. åˆ·æ–°æˆåŠŸï¼Œé‡è¯•åŸè¯·æ±‚
      console.log('âœ… Token åˆ·æ–°æˆåŠŸï¼Œé‡è¯•è¯·æ±‚');
      const newToken = localStorage.getItem('accessToken');
      options.headers['Authorization'] = `Bearer ${newToken}`;
      return fetch(url, options);
    } else {
      // 7. åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•é¡µ
      console.error('âŒ Token åˆ·æ–°å¤±è´¥ï¼Œéœ€è¦é‡æ–°ç™»å½•');
      logout();
      throw new Error('Token åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
    }
  }
  
  // 8. æ­£å¸¸è¿”å›
  return response;
}
```

---

### **æ€»ç»“ï¼šToken è¿‡æœŸçš„ä¿¡å·**

| ä¿¡å· | æ£€æµ‹æ–¹å¼ | å¤„ç†æ–¹å¼ |
|------|---------|---------|
| **HTTP 401** | `response.status === 401` | åˆ·æ–° Token â†’ é‡è¯•è¯·æ±‚ |
| **SSE è¿æ¥å…³é—­** | `eventSource.readyState === EventSource.CLOSED` | åˆ·æ–° Token â†’ é‡æ–°è¿æ¥ |
| **é”™è¯¯ä¿¡æ¯** | è§£æå“åº”ä½“ä¸­çš„ `error` å­—æ®µ | æ ¹æ®é”™è¯¯ç±»å‹å¤„ç† |
| **å®šæ—¶å™¨** | ç™»å½•å 50 åˆ†é’Ÿ | ä¸»åŠ¨åˆ·æ–° Token |

---

## é”™è¯¯å¤„ç†å’Œé‡è¿æœºåˆ¶

### **1. Token è¿‡æœŸå¤„ç†**

```javascript
// å…¨å±€è¯·æ±‚æ‹¦æˆªå™¨
async function fetchWithAuth(url, options = {}) {
  const token = localStorage.getItem('accessToken');
  
  options.headers = {
    ...options.headers,
    'Authorization': `Bearer ${token}`
  };
  
  const response = await fetch(url, options);
  
  // Token è¿‡æœŸï¼Œè‡ªåŠ¨åˆ·æ–°
  if (response.status === 401) {
    console.log('âš ï¸ Token å·²è¿‡æœŸï¼Œå°è¯•åˆ·æ–°...');
    
    const success = await refreshToken();
    if (success) {
      // é‡è¯•åŸè¯·æ±‚
      const newToken = localStorage.getItem('accessToken');
      options.headers['Authorization'] = `Bearer ${newToken}`;
      return fetch(url, options);
    } else {
      // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
      logout();
      throw new Error('Token åˆ·æ–°å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
    }
  }
  
  return response;
}
```

---

### **2. SSE è¿æ¥æ–­å¼€é‡è¿**

```javascript
let reconnectAttempts = 0;
const MAX_RECONNECT_ATTEMPTS = 5;

eventSource.onerror = (error) => {
  console.error('âŒ SSE è¿æ¥é”™è¯¯:', error);
  
  if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
    reconnectAttempts++;
    const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 30000);
    
    console.log(`ğŸ”„ ${delay/1000}ç§’åå°è¯•ç¬¬ ${reconnectAttempts} æ¬¡é‡è¿...`);
    
    setTimeout(() => {
      initSSE();
    }, delay);
  } else {
    console.error('âŒ é‡è¿æ¬¡æ•°è¿‡å¤šï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡æ–°ç™»å½•');
    alert('é€šçŸ¥è¿æ¥å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
    logout();
  }
};

// è¿æ¥æˆåŠŸåé‡ç½®é‡è¿æ¬¡æ•°
eventSource.onopen = () => {
  reconnectAttempts = 0;
  console.log('âœ… SSE è¿æ¥å·²å»ºç«‹');
};
```

---

### **3. åº”ç”¨ä»åå°æ¢å¤**

```javascript
// ç›‘å¬åº”ç”¨å¯è§æ€§å˜åŒ–
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    console.log('ğŸ“± åº”ç”¨æ¢å¤åˆ°å‰å°');
    
    // æ£€æŸ¥ SSE è¿æ¥çŠ¶æ€
    if (!eventSource || eventSource.readyState === EventSource.CLOSED) {
      console.log('ğŸ”„ é‡æ–°å»ºç«‹ SSE è¿æ¥...');
      initSSE();
    }
    
    // æ£€æŸ¥ Token æ˜¯å¦å¿«è¿‡æœŸ
    const loginTime = localStorage.getItem('loginTime');
    if (loginTime) {
      const elapsed = Date.now() - parseInt(loginTime);
      if (elapsed > 50 * 60 * 1000) {  // è¶…è¿‡ 50 åˆ†é’Ÿ
        console.log('ğŸ”„ Token å¿«è¿‡æœŸï¼Œåˆ·æ–°...');
        refreshToken();
      }
    }
  }
});
```

---

## å¸¸è§é—®é¢˜ FAQ

### **Q1: ç™»å½•åå¤šä¹…éœ€è¦åˆ·æ–° Tokenï¼Ÿ**

**A**: accessToken æœ‰æ•ˆæœŸä¸º **1 å°æ—¶**ï¼Œå»ºè®®åœ¨ç™»å½•å **50 åˆ†é’Ÿ**åˆ·æ–°ï¼Œé¿å… Token è¿‡æœŸã€‚

---

### **Q2: SSE è¿æ¥ä½•æ—¶å»ºç«‹ï¼Ÿ**

**A**: **ç™»å½•æˆåŠŸåç«‹å³å»ºç«‹**ï¼Œä¸è¦å»¶è¿Ÿï¼å¦åˆ™ä¼šé”™è¿‡å®æ—¶é€šçŸ¥ã€‚

---

### **Q3: SSE è¿æ¥æ–­å¼€åæ€ä¹ˆåŠï¼Ÿ**

**A**: å®ç°è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼Œä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥ï¼ˆ1ç§’ã€2ç§’ã€4ç§’...æœ€å¤š30ç§’ï¼‰ã€‚

---

### **Q4: ç”¨æˆ·é€€å‡ºç™»å½•åéœ€è¦åšä»€ä¹ˆï¼Ÿ**

**A**: 
1. å…³é—­ SSE è¿æ¥
2. æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ Token
3. è·³è½¬åˆ°ç™»å½•é¡µé¢

---

### **Q5: å¦‚ä½•åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ï¼Ÿ**

**A**: æ£€æŸ¥ `localStorage` ä¸­æ˜¯å¦æœ‰ `accessToken` å’Œ `refreshToken`ã€‚

---

### **Q6: Token åˆ·æ–°å¤±è´¥æ€ä¹ˆåŠï¼Ÿ**

**A**: æç¤ºç”¨æˆ·é‡æ–°ç™»å½•ï¼Œæ¸…é™¤æœ¬åœ° Tokenï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢ã€‚

---

### **Q7: å¤šä¸ªæ ‡ç­¾é¡µå¦‚ä½•å¤„ç†ï¼Ÿ**

**A**: 
- æ¯ä¸ªæ ‡ç­¾é¡µéƒ½å»ºç«‹ç‹¬ç«‹çš„ SSE è¿æ¥
- ä½¿ç”¨ `localStorage` äº‹ä»¶åŒæ­¥ç™»å½•çŠ¶æ€
- ä¸€ä¸ªæ ‡ç­¾é¡µé€€å‡ºç™»å½•ï¼Œå…¶ä»–æ ‡ç­¾é¡µä¹Ÿåº”é€€å‡º

---

### **Q8: ç§»åŠ¨ç«¯åº”ç”¨ä»åå°æ¢å¤æ—¶éœ€è¦åšä»€ä¹ˆï¼Ÿ**

**A**:
1. æ£€æŸ¥ SSE è¿æ¥çŠ¶æ€ï¼Œå¦‚æœæ–­å¼€åˆ™é‡è¿
2. æ£€æŸ¥ Token æ˜¯å¦å¿«è¿‡æœŸï¼Œå¦‚æœæ˜¯åˆ™åˆ·æ–°
3. åˆ·æ–°æœªè¯»é€šçŸ¥æ•°é‡

---

### **Q9: åç«¯å¦‚ä½•å‘ŠçŸ¥å‰ç«¯ Token å·²è¿‡æœŸï¼Ÿ**

**A**: åç«¯é€šè¿‡ **3 ç§æ–¹å¼**å‘ŠçŸ¥ï¼š

1. **HTTP 401 çŠ¶æ€ç **ï¼ˆæœ€å¸¸è§ï¼‰
   - ä»»ä½•æ¥å£è¿”å› `401 Unauthorized`
   - å“åº”ä½“åŒ…å«é”™è¯¯ä¿¡æ¯ï¼š`{"error":"Token æ— æ•ˆæˆ–å·²è¿‡æœŸ"}`

2. **SSE è¿æ¥å…³é—­**
   - Token è¿‡æœŸæ—¶ï¼ŒSSE è¿æ¥ä¼šç«‹å³å…³é—­
   - `eventSource.readyState` å˜ä¸º `EventSource.CLOSED`

3. **å“åº”ä½“é”™è¯¯ä¿¡æ¯**
   - è§£æå“åº”ä½“ä¸­çš„ `error` å­—æ®µ
   - åˆ¤æ–­æ˜¯å¦åŒ…å«"è¿‡æœŸ"ç­‰å…³é”®è¯

**æ¨èåšæ³•**ï¼š
- å®ç°å…¨å±€è¯·æ±‚æ‹¦æˆªå™¨ï¼Œç»Ÿä¸€å¤„ç† 401 é”™è¯¯
- æ”¶åˆ° 401 åè‡ªåŠ¨è°ƒç”¨ `/auth/refresh` åˆ·æ–° Token
- åˆ·æ–°æˆåŠŸåé‡è¯•åŸè¯·æ±‚ï¼Œå¤±è´¥åˆ™è·³è½¬ç™»å½•é¡µ

---

### **Q10: ä»€ä¹ˆæ—¶å€™åº”è¯¥è°ƒç”¨ /auth/refresh æ¥å£ï¼Ÿ**

**A**: **4 ä¸ªæ—¶æœº**ï¼š

1. **å®šæ—¶ä¸»åŠ¨åˆ·æ–°ï¼ˆæ¨èï¼‰â­**
   - ç™»å½•å 50 åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°
   - é¿å… Token è¿‡æœŸå¯¼è‡´è¯·æ±‚å¤±è´¥

2. **æ”¶åˆ° 401 é”™è¯¯æ—¶ï¼ˆè¢«åŠ¨åˆ·æ–°ï¼‰**
   - ä»»ä½•æ¥å£è¿”å› 401
   - ç«‹å³è°ƒç”¨åˆ·æ–°æ¥å£

3. **SSE è¿æ¥å¤±è´¥æ—¶**
   - SSE è¿æ¥å…³é—­ä¸” `readyState === EventSource.CLOSED`
   - åˆ·æ–°åé‡æ–°å»ºç«‹è¿æ¥

4. **åº”ç”¨ä»åå°æ¢å¤æ—¶ï¼ˆå¯é€‰ï¼‰**
   - æ£€æµ‹åˆ° Token å¿«è¿‡æœŸï¼ˆè·ç¦»ç™»å½•è¶…è¿‡ 50 åˆ†é’Ÿï¼‰
   - ä¸»åŠ¨åˆ·æ–°

**ä¼˜å…ˆçº§**ï¼šå®šæ—¶ä¸»åŠ¨åˆ·æ–° > è¢«åŠ¨åˆ·æ–°

---

### **Q11: åˆ·æ–° Token åéœ€è¦åšä»€ä¹ˆï¼Ÿ**

**A**: **å¿…é¡»åš 3 ä»¶äº‹**ï¼š

1. **æ›´æ–°æœ¬åœ°å­˜å‚¨**
   ```javascript
   localStorage.setItem('accessToken', newAccessToken);
   localStorage.setItem('refreshToken', newRefreshToken);
   ```

2. **é‡æ–°å»ºç«‹ SSE è¿æ¥**
   ```javascript
   // å…³é—­æ—§è¿æ¥
   if (eventSource) eventSource.close();
   
   // ä½¿ç”¨æ–° Token å»ºç«‹è¿æ¥
   await initSSE();
   ```

3. **é‡è¯•å¤±è´¥çš„è¯·æ±‚ï¼ˆå¦‚æœæœ‰ï¼‰**
   ```javascript
   // ä½¿ç”¨æ–° Token é‡è¯•
   options.headers['Authorization'] = `Bearer ${newToken}`;
   return fetch(url, options);
   ```

**âš ï¸ æ³¨æ„**ï¼šå¦‚æœä¸é‡æ–°å»ºç«‹ SSE è¿æ¥ï¼Œä¼šå¯¼è‡´é€šçŸ¥æ¨é€å¤±è´¥ï¼

---

## ğŸ“ æ¥å£è°ƒç”¨é¡ºåºæ€»ç»“

### **æ ‡å‡†æµç¨‹**

```
1. POST /auth/login
   â†“ ä¿å­˜ Token
2. GET /notifications/stream
   â†“ ç›‘å¬é€šçŸ¥
3. å®šæ—¶åˆ·æ–° (50åˆ†é’Ÿå)
   POST /auth/refresh
   â†“ æ›´æ–° Token
4. é‡æ–°å»ºç«‹ SSE è¿æ¥
   GET /notifications/stream
```

### **åº”ç”¨å¯åŠ¨æµç¨‹**

```
1. æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰ Token
   â†“ æœ‰ Token
2. éªŒè¯ Token æ˜¯å¦æœ‰æ•ˆ
   â†“ æœ‰æ•ˆ
3. GET /notifications/stream
   â†“ å»ºç«‹è¿æ¥
4. å¯åŠ¨å®šæ—¶åˆ·æ–°
```

### **Token è¿‡æœŸå¤„ç†**

```
1. æ”¶åˆ° 401 é”™è¯¯
   â†“
2. POST /auth/refresh
   â†“ åˆ·æ–°æˆåŠŸ
3. é‡è¯•åŸè¯·æ±‚
   â†“
4. é‡æ–°å»ºç«‹ SSE è¿æ¥
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-18  
**è”ç³»æ–¹å¼**: åç«¯å¼€å‘å›¢é˜Ÿ
