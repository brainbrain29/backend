# 任务附件上传 API 文档

## 接口信息

**接口地址：** `POST /tasks`

**Content-Type：** `multipart/form-data`

**身份验证：** 必需（JWT Token）

## 功能说明

创建新任务并支持上传附件文件。此接口使用 `multipart/form-data` 格式支持文件上传，可以同时上传多个附件。

## 身份验证

必需。需要在请求头中包含 JWT Token：

```
Authorization: Bearer <你的JWT令牌>
```

## 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| `title` | 字符串 | **是** | 任务标题 |
| `content` | 字符串 | **是** | 任务描述/内容 |
| `startTime` | 字符串 | 否 | 任务开始时间（ISO 8601 格式） |
| `endTime` | 字符串 | 否 | 任务结束时间（ISO 8601 格式） |
| `taskPriority` | 字符串 | 否 | 任务优先级："低"、"中"、"高" |
| `taskType` | 字符串 | 否 | 任务类型："开发"、"测试"、"设计"、"其他" |
| `assigneeId` | 整数 | 否 | 任务执行者的员工ID |
| `milestoneId` | 整数 | 否 | 任务所属里程碑的ID |
| `files` | 文件数组 | 否 | 要上传的附件文件（支持多个文件） |

### 时间格式说明

`startTime` 和 `endTime` 使用 ISO 8601 格式：

```
2025-11-20T10:00:00
```

**注意：** 时间格式必须严格遵循 ISO 8601 标准，否则会导致解析错误。

## 请求示例

### JavaScript (原生 Fetch)

```javascript
// 准备表单数据
const formData = new FormData();

// 必填字段
formData.append('title', '完成项目报告');
formData.append('content', '需要完成Q4季度的项目总结报告');

// 可选字段
formData.append('startTime', '2025-11-20T09:00:00');
formData.append('endTime', '2025-11-25T18:00:00');
formData.append('taskPriority', '高');
formData.append('taskType', '开发');
formData.append('assigneeId', '5');
formData.append('milestoneId', '10');

// 添加文件（支持多个文件）
const fileInput = document.getElementById('fileInput');
for (let i = 0; i < fileInput.files.length; i++) {
  formData.append('files', fileInput.files[i]);
}

// 发送请求
fetch('/tasks', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`
    // 注意：不要手动设置 Content-Type，浏览器会自动设置
  },
  body: formData
})
  .then(response => response.json())
  .then(data => {
    console.log('任务创建成功:', data);
  })
  .catch(error => {
    console.error('错误:', error);
  });
```

### Axios

```javascript
import axios from 'axios';

const formData = new FormData();
formData.append('title', '完成项目报告');
formData.append('content', '需要完成Q4季度的项目总结报告');
formData.append('taskPriority', '高');
formData.append('taskType', '开发');

// 添加文件
files.forEach(file => {
  formData.append('files', file);
});

axios.post('/tasks', formData, {
  headers: {
    'Authorization': `Bearer ${token}`,
    // Content-Type 会被 axios 自动设置
  }
})
  .then(response => {
    console.log('任务创建成功:', response.data);
  })
  .catch(error => {
    console.error('错误:', error);
  });
```

### React 完整示例

```jsx
import React, { useState } from 'react';

function CreateTaskForm() {
  const [files, setFiles] = useState([]);
  const [formData, setFormData] = useState({
    title: '',
    content: '',
    taskPriority: '中',
    taskType: '开发'
  });

  const handleFileChange = (e) => {
    setFiles(Array.from(e.target.files));
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    
    const data = new FormData();
    data.append('title', formData.title);
    data.append('content', formData.content);
    data.append('taskPriority', formData.taskPriority);
    data.append('taskType', formData.taskType);
    
    // 添加文件
    files.forEach(file => {
      data.append('files', file);
    });
    
    try {
      const response = await fetch('/tasks', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: data
      });
      
      const result = await response.json();
      console.log('任务创建成功:', result);
      alert('任务创建成功！');
    } catch (error) {
      console.error('错误:', error);
      alert('任务创建失败');
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      <div>
        <label>任务标题：</label>
        <input
          type="text"
          placeholder="请输入任务标题"
          value={formData.title}
          onChange={(e) => setFormData({...formData, title: e.target.value})}
          required
        />
      </div>
      
      <div>
        <label>任务内容：</label>
        <textarea
          placeholder="请输入任务描述"
          value={formData.content}
          onChange={(e) => setFormData({...formData, content: e.target.value})}
          required
        />
      </div>
      
      <div>
        <label>优先级：</label>
        <select
          value={formData.taskPriority}
          onChange={(e) => setFormData({...formData, taskPriority: e.target.value})}
        >
          <option value="低">低</option>
          <option value="中">中</option>
          <option value="高">高</option>
        </select>
      </div>
      
      <div>
        <label>任务类型：</label>
        <select
          value={formData.taskType}
          onChange={(e) => setFormData({...formData, taskType: e.target.value})}
        >
          <option value="开发">开发</option>
          <option value="测试">测试</option>
          <option value="设计">设计</option>
          <option value="其他">其他</option>
        </select>
      </div>
      
      <div>
        <label>上传附件：</label>
        <input
          type="file"
          multiple
          onChange={handleFileChange}
        />
        {files.length > 0 && (
          <p>已选择 {files.length} 个文件</p>
        )}
      </div>
      
      <button type="submit">创建任务</button>
    </form>
  );
}

export default CreateTaskForm;
```

## 响应格式

### 成功响应 (201 Created)

```json
{
  "taskId": 123,
  "title": "完成项目报告",
  "content": "需要完成Q4季度的项目总结报告",
  "startTime": "2025-11-20T09:00:00",
  "endTime": "2025-11-25T18:00:00",
  "taskStatus": "未完成",
  "taskPriority": "高",
  "taskType": "开发",
  "senderId": 1,
  "senderName": "张三",
  "assigneeId": 5,
  "assigneeName": "李四",
  "milestoneId": 10,
  "milestoneName": "第一阶段",
  "projectId": 3,
  "projectName": "项目A",
  "attachments": [
    {
      "attachmentId": 456,
      "originalFilename": "项目报告.pdf",
      "fileType": "application/pdf",
      "fileSize": 1024000,
      "uploadTime": "2025-11-20T10:30:00"
    },
    {
      "attachmentId": 457,
      "originalFilename": "截图.png",
      "fileType": "image/png",
      "fileSize": 512000,
      "uploadTime": "2025-11-20T10:30:01"
    }
  ]
}
```

**响应字段说明：**

| 字段 | 类型 | 说明 |
|------|------|------|
| `taskId` | 整数 | 任务ID |
| `title` | 字符串 | 任务标题 |
| `content` | 字符串 | 任务内容 |
| `taskStatus` | 字符串 | 任务状态（"未完成"、"未接收"、"进行中"、"已完成"） |
| `senderId` / `senderName` | 整数/字符串 | 创建者ID和姓名 |
| `assigneeId` / `assigneeName` | 整数/字符串 | 执行者ID和姓名 |
| `milestoneId` / `milestoneName` | 整数/字符串 | 里程碑ID和名称 |
| `projectId` / `projectName` | 整数/字符串 | 项目ID和名称 |
| `attachments` | 数组 | 附件列表 |
| `attachments[].attachmentId` | 整数 | 附件ID（用于预览和下载） |
| `attachments[].originalFilename` | 字符串 | 原始文件名 |
| `attachments[].fileType` | 字符串 | MIME类型 |
| `attachments[].fileSize` | 长整数 | 文件大小（字节） |
| `attachments[].uploadTime` | 字符串 | 上传时间 |

### 错误响应

#### 401 未授权

```json
"Missing or invalid token"
```

**原因：** JWT Token 无效或未提供

#### 400 请求错误

```json
"创建任务失败: <错误信息>"
```

**常见错误信息：**
- `Sender ID is required` - 发送者ID必填（从Token中提取失败）
- `Sender not found` - 发送者不存在
- `Assignee not found` - 指定的执行者不存在
- `Milestone not found` - 指定的里程碑不存在
- `文件上传失败: <文件名>` - 文件上传过程中出错
- `For input string: "xxx"` - 时间格式错误

## 重要说明

### 1. Content-Type 请求头

**不要**手动设置 `Content-Type` 为 `multipart/form-data`。浏览器或 HTTP 客户端会自动设置正确的 boundary 参数。

❌ **错误做法：**

```javascript
headers: {
  'Content-Type': 'multipart/form-data'  // 不要这样做！
}
```

✅ **正确做法：**

```javascript
headers: {
  'Authorization': `Bearer ${token}`
  // Content-Type 会自动设置
}
```

### 2. 文件字段名称

文件字段名必须是 `files`（复数形式），不是 `file`。

```javascript
formData.append('files', file);  // 正确
```

### 3. 上传多个文件

要上传多个文件，使用相同的字段名多次添加：

```javascript
files.forEach(file => {
  formData.append('files', file);
});
```

### 4. 任务状态自动设置

任务状态由后端自动确定：

- 如果指定了 `assigneeId` 且与当前用户不同：状态 = "未接收"
- 否则：状态 = "未完成"

### 5. 发送者ID

`senderId` 会自动从 JWT Token 中提取当前用户ID，**无需在请求中提供**。

### 6. 支持的文件类型

支持所有文件类型，常见类型包括：

- **文档：** PDF、Word、Excel、PowerPoint
- **图片：** PNG、JPG、GIF、SVG
- **压缩包：** ZIP、RAR
- **代码：** TXT、JSON、XML
- **其他：** 所有类型

### 7. 文件大小限制

请咨询后端配置的最大文件大小限制（通常在 `application.properties` 中配置）。

默认配置参考：
```properties
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=50MB
```

## 相关接口

- **预览任务附件：** `GET /tasks/attachments/{id}/preview`
- **下载任务附件：** `GET /tasks/attachments/{id}/download`
- **查询任务详情：** `GET /tasks/{id}`
- **更新任务：** `PUT /tasks/{id}`

## 使用 cURL 测试

```bash
curl -X POST http://localhost:8080/tasks \
  -H "Authorization: Bearer 你的JWT令牌" \
  -F "title=完成项目报告" \
  -F "content=需要完成Q4季度的项目总结报告" \
  -F "taskPriority=高" \
  -F "taskType=开发" \
  -F "assigneeId=5" \
  -F "files=@/路径/文件1.pdf" \
  -F "files=@/路径/文件2.png"
```

## 常见问题排查

### 问题：文件没有上传

**解决方案：** 确保使用 `FormData` 而不是发送 JSON。文件无法通过 JSON 格式发送。

### 问题：401 未授权错误

**解决方案：** 检查 JWT Token 是否有效，是否正确包含在 Authorization 请求头中。

### 问题：时间解析错误

**解决方案：** 确保时间字符串使用 ISO 8601 格式：`YYYY-MM-DDTHH:mm:ss`

示例：`2025-11-20T10:00:00`

### 问题："创建任务失败"错误

**解决方案：** 查看具体错误信息。常见问题：

- 缺少必填字段（`title`、`content`）
- 无效的 `assigneeId` 或 `milestoneId`
- 文件上传失败（检查文件大小和权限）

### 问题：文件上传后数据库中没有记录

**解决方案：**

1. 检查后端日志是否有错误信息
2. 确认 `task_attachment` 表已创建
3. 检查文件存储路径是否有写入权限
4. 验证 `FileStorageService` 配置是否正确

---

**文档版本：** 1.0  
**最后更新：** 2025-11-20  
**维护者：** 后端开发团队