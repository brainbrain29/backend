# é™„ä»¶é¢„è§ˆ 403 é—®é¢˜è§£å†³æ–¹æ¡ˆ

## ğŸ› é—®é¢˜æè¿°

é™„ä»¶é¢„è§ˆæ—¶å‡ºç° 403 Forbidden é”™è¯¯ï¼Œå³ä½¿å‰ç«¯å°è¯•åœ¨è¯·æ±‚å¤´ä¸­æ·»åŠ  Tokenã€‚

## ğŸ” æ ¹æœ¬åŸå› 

**WebView çš„è¯·æ±‚å¤´é™åˆ¶**ï¼š
- Android WebView é€šè¿‡ `loadRequest` è®¾ç½®çš„è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼ˆå¦‚ `Authorization`ï¼‰å¯èƒ½ä¸ä¼šåœ¨æ‰€æœ‰æƒ…å†µä¸‹ç”Ÿæ•ˆ
- ç‰¹åˆ«æ˜¯é‡å®šå‘ã€iframeã€èµ„æºåŠ è½½ç­‰åœºæ™¯ï¼Œè‡ªå®šä¹‰è¯·æ±‚å¤´ä¼šä¸¢å¤±
- è¿™æ˜¯ WebView çš„å·²çŸ¥é™åˆ¶

## âœ… è§£å†³æ–¹æ¡ˆï¼šURL å‚æ•°ä¼ é€’ Token

### å‰ç«¯ä¿®æ”¹

#### 1. ä¿®æ”¹ `log_service.dart`

```dart
// è·å–é™„ä»¶é¢„è§ˆ URL
String getAttachmentPreviewUrl(int attachmentId, {String? token}) {
  final baseUrl = '$kApiBaseUrl/logs/attachments/$attachmentId/preview';
  if (token != null && token.isNotEmpty) {
    return '$baseUrl?token=$token';  // âœ… Token ä½œä¸º URL å‚æ•°
  }
  return baseUrl;
}
```

#### 2. ä¿®æ”¹è°ƒç”¨æ–¹ï¼ˆ`log_detail_sheet.dart` å’Œ `task_detail_sheet.dart`ï¼‰

```dart
Future<void> _previewAttachment(LogAttachment attachment) async {
  // è·å– Token
  const storage = FlutterSecureStorage();
  final token = await storage.read(key: 'accessToken');
  
  // ä¼ é€’ Token åˆ° URL
  final url = _service.getAttachmentPreviewUrl(attachment.id!, token: token);
  
  Navigator.of(context).push(
    MaterialPageRoute(
      builder: (_) => AttachmentPreviewPage(url: url, filename: ...),
    ),
  );
}
```

### åç«¯ä¿®æ”¹ï¼ˆéœ€è¦åç«¯åŒå­¦é…åˆï¼‰

åç«¯éœ€è¦æ”¯æŒä» URL å‚æ•°ä¸­è¯»å– Tokenï¼š

```java
@GetMapping("/attachments/{id}/preview")
public ResponseEntity<Resource> previewAttachment(
    @PathVariable("id") Long attachmentId,
    @RequestParam(value = "token", required = false) String tokenParam,  // âœ… ä» URL å‚æ•°è¯»å–
    HttpServletRequest request) {
    
    // 1. ä¼˜å…ˆä» URL å‚æ•°è·å– Token
    String token = tokenParam;
    
    // 2. å¦‚æœ URL å‚æ•°æ²¡æœ‰ï¼Œå†ä» Header è·å–
    if (token == null || token.isEmpty()) {
        String authHeader = request.getHeader("Authorization");
        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            token = authHeader.substring(7);
        }
    }
    
    // 3. éªŒè¯ Token
    if (token == null || token.isEmpty()) {
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
    }
    
    // 4. è§£æ Token è·å–ç”¨æˆ·ID
    Integer userId = jwtUtil.getUserIdFromToken(token);
    if (userId == null) {
        return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
    }
    
    // 5. æ£€æŸ¥æƒé™
    LogAttachment attachment = logAttachmentRepository.findById(attachmentId)
        .orElseThrow(() -> new RuntimeException("æ–‡ä»¶æœªæ‰¾åˆ°"));
    
    Log log = attachment.getLog();
    if (!log.getEmployee().getEmployeeId().equals(userId)) {
        return ResponseEntity.status(HttpStatus.FORBIDDEN).build();
    }
    
    // 6. è¿”å›æ–‡ä»¶
    Resource resource = fileStorageService.loadFileAsResource(attachment.getStoredFilename());
    
    return ResponseEntity.ok()
        .contentType(MediaType.parseMediaType(attachment.getFileType()))
        .header(HttpHeaders.CONTENT_DISPOSITION, "inline; filename=\"" + attachment.getOriginalFilename() + "\"")
        .body(resource);
}
```

## ğŸ“‹ æµ‹è¯•æ­¥éª¤

### 1. å‰ç«¯æµ‹è¯•

é‡æ–°è¿è¡Œåº”ç”¨ï¼š
```bash
flutter run
```

ç‚¹å‡»é™„ä»¶é¢„è§ˆï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š
```
[LogDetail] ğŸ”— é¢„è§ˆURL: http://192.168.43.23:8080/logs/attachments/1/preview?token=eyJhbGci...
[AttachmentPreview] ğŸ”„ ========== å¼€å§‹åˆå§‹åŒ–é¢„è§ˆ ==========
[AttachmentPreview] ğŸ“„ é¡µé¢å¼€å§‹åŠ è½½: http://...?token=...
```

### 2. åç«¯æµ‹è¯•

ç¡®è®¤åç«¯èƒ½ä» URL å‚æ•°ä¸­è¯»å– Tokenï¼š
```bash
curl "http://192.168.43.23:8080/logs/attachments/1/preview?token=YOUR_TOKEN"
```

## ğŸ¯ ä¼˜ç¼ºç‚¹åˆ†æ

### âœ… ä¼˜ç‚¹
- **å…¼å®¹æ€§å¥½**ï¼šæ‰€æœ‰å¹³å°çš„ WebView éƒ½æ”¯æŒ URL å‚æ•°
- **ç®€å•å¯é **ï¼šä¸ä¾èµ–è¯·æ±‚å¤´
- **æ˜“äºè°ƒè¯•**ï¼šå¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨ä¸­æµ‹è¯•

### âš ï¸ ç¼ºç‚¹
- **å®‰å…¨æ€§ç¨ä½**ï¼šToken æš´éœ²åœ¨ URL ä¸­
  - å¯èƒ½è¢«è®°å½•åˆ°æœåŠ¡å™¨æ—¥å¿—
  - å¯èƒ½è¢«æµè§ˆå™¨å†å²è®°å½•
  - å¯èƒ½è¢«ä»£ç†æœåŠ¡å™¨è®°å½•

### ğŸ”’ å®‰å…¨å»ºè®®

1. **ä½¿ç”¨çŸ­æœŸ Token**ï¼šé¢„è§ˆ Token åº”è¯¥æœ‰è¾ƒçŸ­çš„æœ‰æ•ˆæœŸï¼ˆå¦‚ 5 åˆ†é’Ÿï¼‰
2. **ä¸€æ¬¡æ€§ Token**ï¼šå¯ä»¥ç”Ÿæˆä¸“é—¨ç”¨äºé¢„è§ˆçš„ä¸€æ¬¡æ€§ Token
3. **HTTPS**ï¼šç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨ HTTPS
4. **æ—¥å¿—è„±æ•**ï¼šåç«¯æ—¥å¿—åº”è¯¥è„±æ• Token å‚æ•°

## ğŸš€ æ›¿ä»£æ–¹æ¡ˆï¼ˆå¦‚æœ URL å‚æ•°ä¸å¯è¡Œï¼‰

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨ Cookie

å‰ç«¯åœ¨ç™»å½•åè®¾ç½® Cookieï¼ŒWebView ä¼šè‡ªåŠ¨æºå¸¦ï¼š
```dart
// ç™»å½•æˆåŠŸå
await _dio.post('/login', ...);
// Cookie ä¼šè‡ªåŠ¨ä¿å­˜
```

åç«¯ä» Cookie è¯»å– Tokenï¼š
```java
Cookie[] cookies = request.getCookies();
// è¯»å– Token Cookie
```

### æ–¹æ¡ˆ3ï¼šä½¿ç”¨ä¸´æ—¶è®¿é—®ç 

1. å‰ç«¯è¯·æ±‚ç”Ÿæˆä¸´æ—¶è®¿é—®ç 
2. ä½¿ç”¨è®¿é—®ç è®¿é—®é™„ä»¶
3. è®¿é—®ç æœ‰æ•ˆæœŸå¾ˆçŸ­ï¼ˆ1åˆ†é’Ÿï¼‰

---

## ğŸ“ æ€»ç»“

**æ¨èä½¿ç”¨ URL å‚æ•°æ–¹æ¡ˆ**ï¼Œå› ä¸ºï¼š
1. å®ç°ç®€å•
2. å…¼å®¹æ€§æœ€å¥½
3. å¯¹äºé¢„è§ˆåœºæ™¯ï¼Œå®‰å…¨æ€§å¯æ¥å—

**éœ€è¦åç«¯é…åˆä¿®æ”¹**ï¼Œæ”¯æŒä» URL å‚æ•°è¯»å– Tokenã€‚
